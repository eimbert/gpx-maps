<div class="container">
  <div class="mode-toggle">
    <button class="mode-button" [class.active]="mode === 'routes'" (click)="selectMode('routes')">
      üöµ‚Äç‚ôÄÔ∏è Animar GPX
    </button>
    <button class="mode-button" [class.active]="mode === 'events'" (click)="selectMode('events')">
      üèÅ Eventos y rankings
    </button>
  </div>

  <section *ngIf="mode === 'routes'" class="load-wrapper">
    <header class="hero">
      <div>
        <h1>Anima tus Rutas</h1>
        <p>Arrastra y suelta hasta {{ maxTracks }} recorridos o pulsa para seleccionarlos.</p>
      </div>
    </header>

    <div
      class="dropzone"
      [class.dropzone--active]="isDragOver"
      (click)="triggerFileDialog()"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave()"
      (drop)="onDrop($event)"
    >
      <input
        #fileInput
        type="file"
        accept=".gpx"
        multiple
        (change)="onFileInputChange($event)"
        hidden
      />

      <div class="dropzone__content">
        <div class="icon">üìÇ</div>
        <p class="title">Suelta aqu√≠ tus archivos GPX</p>
        <p class="subtitle">Tambi√©n puedes pulsar para abrir el selector</p>
        <button type="button" class="secondary">A√±adir archivos</button>
      </div>
    </div>

    <section class="tracks" *ngIf="tracks.length">
      <h2>Tracks cargados</h2>
      <ul class="file-list">
        <li class="file-item" *ngFor="let track of tracks; index as i">
          <span class="file-pill">{{ i + 1 }}</span>
          <div class="file-texts">
            <span class="file-name" [title]="track.fileName">{{ track.fileName }}</span>
            <span class="file-alias" [title]="track.name">{{ track.name }}</span>
          </div>
          <button type="button" class="ghost" (click)="borrarFichero(i)">Quitar</button>
        </li>
      </ul>
    </section>

    <button (click)="iniciarVisualizacion()" [disabled]="!tracksCargados()" class="btn-start">
      <span>Iniciar</span>
      <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="btn-start__icon">
        <path d="M5 3l14 9-14 9V3z" fill="currentColor" />
      </svg>
    </button>
  </section>

  <section *ngIf="mode === 'events'" class="events-wrapper">
    <header class="hero events-hero">
      <div>
        <p style="color: beige; padding-bottom: 10px;">Ranking social</p>
        <h1  style="color: yellow;">Elige evento, sube tu track y anima la carrera</h1>
        <p style="color: beige;">Explora recorridos</p>
        <p style="color: beige;">S√∫mate al ranking por categor√≠a</p>
        <p style="color: beige;">Compara tu GPX con otros riders</p>
      </div>
    </header>

    <div class="events-actions">
      <button type="button" class="secondary" style="cursor: pointer;" (click)="openEventSearch()">üîç Buscar eventos</button>
      <button type="button" class="secondary" style="cursor: pointer;" (click)="openCreateEventDialog()">‚ûï Crear nuevo evento</button>
      <button
        *ngIf="canDeleteSelectedEvent()"
        type="button"
        class="ghost ghost--danger"
        (click)="deleteSelectedEvent()"
      >
        üóëÔ∏è Eliminar evento
      </button>
    </div>

    <ng-container *ngIf="events.length; else emptyEvents">
      <div class="events-carousel">
        <div class="carousel-window">
          <div class="carousel-track">
            <article
              *ngFor="let event of events; index as i"
              class="event-card event-card--carousel"
              [ngStyle]="{ '--event-logo-url': 'url(' + getEventLogo(event) + ')' }"
              [class.event-card--active]="event.id === selectedEventId"
              [class.event-card--current]="i === carouselIndex"
              (click)="handleCarouselSelection(event.id)"
            >
              <div class="event-card__header">
                <div>
                  <p class="eyebrow">{{ event.year }}</p>
                  <h3>{{ event.name }}</h3>
                  <p class="muted">{{ getEventLocation(event) }}</p>
                </div>
              </div>
              <div class="pill-group">
                <span class="pill" *ngFor="let modality of event.modalities">{{ modality.name }} ¬∑ {{ modality.distanceKm }} km</span>
              </div>
              <p class="muted">{{ event.tracks.length }} tracks subidos</p>
              <div class="event-card__ranking" *ngIf="getEventRanking(event, 5).length">
                <p class="eyebrow">Top tiempos</p>
                <ol>
                  <li *ngFor="let track of getEventRanking(event, 5); index as i">
                    <span class="position">#{{ i + 1 }}</span>
                    <div class="event-card__runner">
                      <p class="strong">{{ track.nickname }}</p>
                      <p class="muted">{{track.category}} ¬∑ {{ findModalityNameForEvent(event, track.modalityId) }}</p>
                    </div>
                    <span class="time">{{ formatTime(track.timeSeconds) }}</span>
                  </li>
                </ol>
              </div>

            </article>
          </div>
        </div>
      </div>


    </ng-container>

    <ng-template #emptyEvents>
      <p class="muted">No hay eventos disponibles todav√≠a.</p>
    </ng-template>

    <section *ngIf="events.length" class="event-detail">
      <div class="event-panels">
        <article class="panel">
          <div class="panel__header panel__header--stacked">
            <div>
              <h3>Sube tu track</h3>
              <p class="muted">Nick, categor√≠a, bici y GPX para entrar al ranking autom√°tico.</p>
            </div>
            <div class="event-selection">
              <div class="event-status" [class.event-status--empty]="!selectedEvent">
                <p class="eyebrow">Evento seleccionado</p>
                <ng-container *ngIf="selectedEvent; else noEventSelected">
                  <p class="event-status__title">{{ selectedEvent.name }}</p>
                  <p class="muted">{{ selectedEvent.year }} ‚Ä¢ {{ getEventLocation(selectedEvent) }}</p>
                </ng-container>
                <ng-template #noEventSelected>
                  <p class="event-status__title">Ning√∫n evento seleccionado</p>
                  <p class="muted">Elige un evento para habilitar la subida.</p>
                </ng-template>
              </div>
              <div class="event-logo-preview" [class.event-logo-preview--empty]="!selectedEvent">
                <ng-container *ngIf="selectedEvent; else logoPlaceholder">
                  <img
                    [src]="getEventLogo(selectedEvent)"
                    [alt]="selectedEvent.name + ' logo'"
                    class="event-logo-preview__image"
                  />
                </ng-container>
                <ng-template #logoPlaceholder>
                  <span class="muted">Sin logo</span>
                </ng-template>
              </div>
            </div>
          </div>
          <div class="form-grid">
            <label>
              <span>Evento</span>
              <select [ngModel]="selectedEventId" (ngModelChange)="handleEventSelection($event)">
                <option value="">Selecciona un evento</option>
                <option *ngFor="let event of events" [ngValue]="event.id">{{ event.name }} ({{ event.year }})</option>
              </select>
            </label>
            <label>
              <span>Nick name</span>
              <input type="text" [(ngModel)]="eventUpload.nickname" placeholder="Tu alias" />
            </label>
            <label>
              <span>Categor√≠a</span>
              <select [(ngModel)]="eventUpload.category">
                <option *ngFor="let category of categories" [ngValue]="category">{{ category }}</option>
              </select>
            </label>
            <label>
              <span>Modalidad</span>
              <select
                [(ngModel)]="eventUpload.modalityId"
                (ngModelChange)="onModalityChange($event)"
                [disabled]="!selectedEvent"
              >
                <option value="" disabled>Selecciona un recorrido</option>
                <option *ngFor="let modality of selectedEvent?.modalities || []" [ngValue]="modality.id">{{ modality.name }}</option>
              </select>
            </label>
            <label>
              <span>Tipo de bicicleta</span>
              <select [(ngModel)]="eventUpload.bikeType">
                <option *ngFor="let bike of bikeTypes" [ngValue]="bike">{{ bike }}</option>
              </select>
            </label>
            <label class="file-input">
              <span>Track GPX</span>
              <input #eventFileInput type="file" accept=".gpx" (change)="onEventFileChange($event)" [disabled]="!selectedEvent" />
            </label>
          </div>
          <button class="btn-start" type="button" (click)="uploadTrackToEvent()" [disabled]="!canUploadToEvent()">
            <span>Enviar al ranking</span>
          </button>
        </article>

        <article class="panel">
          <ng-container *ngIf="selectedEvent; else rankingPlaceholder">
            <div class="panel__header">
              <h3>Ranking mejor tiempo</h3>
              <p class="muted">Tu mejor marca se conserva, el resto queda en historial personal.</p>
            </div>
            <ol class="ranking">
              <li *ngFor="let track of ranking; index as i" [class.ranking__item--mine]="track.id === latestUploadedTrackId || track.nickname === personalNickname">
                <span class="position">#{{ i + 1 }}</span>
                <div>
                  <p class="strong">{{ track.nickname }} ¬∑ {{ findModalityName(track.modalityId) }}</p>
                  <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
                </div>
                <div class="ranking__actions">
                  <span class="time">{{ formatTime(track.timeSeconds) }}</span>
                  <button
                    *ngIf="canDeleteTrack(track)"
                    type="button"
                    class="icon-button"
                    (click)="deleteTrack(track.id)">
                    üóëÔ∏è
                  </button>
                </div>
              </li>
            </ol>
          </ng-container>
          <ng-template #rankingPlaceholder>
            <div class="panel__header">
              <h3>Ranking mejor tiempo</h3>
              <p class="muted">Selecciona un evento para ver el ranking.</p>
            </div>
          </ng-template>
        </article>
      </div>

      <article class="panel">
        <ng-container *ngIf="selectedEvent; else selectionPlaceholder">
          <div class="panel__header">
            <h3>Elige hasta 4 rivales</h3>
            <p class="muted">Activa los que quieras comparar y pulsa "Animar selecci√≥n".</p>
          </div>
          <div class="track-grid">
            <label class="track-card" *ngFor="let track of availableTracks">
              <input type="checkbox" [checked]="selectedComparisonIds.has(track.id)" (change)="toggleComparisonSelection(track.id)" />
              <div>
                <p class="strong">{{ track.nickname }} ¬∑ {{ findModalityName(track.modalityId) }}</p>
                <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }} ¬∑ {{ formatTime(track.timeSeconds) }}</p>
              </div>
              <span class="pill">{{ track.distanceKm | number:'1.0-1' }} km</span>
              <button
                *ngIf="canDeleteTrack(track)"
                type="button"
                class="icon-button"
                (click)="deleteTrack(track.id); $event.stopPropagation(); $event.preventDefault();">
                üóëÔ∏è
              </button>
            </label>
          </div>
          <div class="actions">
            <button class="btn-start" type="button" (click)="animateSelectedTracks()">Animar selecci√≥n</button>
          </div>
        </ng-container>
        <ng-template #selectionPlaceholder>
          <div class="panel__header">
            <h3>Elige hasta 4 rivales</h3>
            <p class="muted">Selecciona un evento para ver los aportes disponibles.</p>
          </div>
        </ng-template>
      </article>

      <article class="panel" *ngIf="personalHistory.length">
        <div class="panel__header">
          <h3>Historial de {{ personalNickname }}</h3>
          <p class="muted">Guardamos todos tus intentos, el ranking usa tu mejor tiempo.</p>
        </div>
        <ul class="history">
          <li *ngFor="let track of personalHistory">
            <div>
              <p class="strong">{{ findModalityName(track.modalityId) }}</p>
              <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
            </div>
            <div class="history__meta">
              <span class="pill">{{ formatTime(track.timeSeconds) }}</span>
              <span class="muted">{{ track.uploadedAt | date:'medium' }}</span>
              <button
                *ngIf="canDeleteTrack(track)"
                type="button"
                class="icon-button"
                (click)="deleteTrack(track.id, selectedEventId || undefined)">
                üóëÔ∏è
              </button>
            </div>
          </li>
        </ul>
      </article>
    </section>
  </section>
</div>
