<div class="plan">
  <header class="plan__toolbar">
    <div class="plan__toolbar-left">
      <button class="plan__home-button" type="button" (click)="goHome()" aria-label="Volver al inicio">
        <mat-icon aria-hidden="true">home</mat-icon>
        Inicio
      </button>
      <div class="plan__search">
        <mat-icon aria-hidden="true">search</mat-icon>
        <input type="text" [(ngModel)]="folderSearch" (input)="applyFolderFilter()" placeholder="Buscar carpeta"
          aria-label="Buscar carpeta">
      </div>
    </div>
    <div class="plan__toolbar-actions">
      <button class="plan__primary" type="button" (click)="toggleNewFolderForm()">
        Nueva carpeta
      </button>
    </div>
  </header>

  <section class="plan__new" *ngIf="showNewFolderForm">
    <div class="plan__new-fields">
      <label>
        Nombre de carpeta
        <input type="text" [(ngModel)]="newFolderName" placeholder="Ej: Salida al Montseny">
      </label>
      <label>
        Fecha prevista
        <mat-form-field  class="plan__date-field" appearance="fill">
          <input matInput [matDatepicker]="newFolderPicker" [(ngModel)]="newFolderDate">
          <mat-datepicker-toggle matIconSuffix [for]="newFolderPicker"></mat-datepicker-toggle>
          <mat-datepicker #newFolderPicker></mat-datepicker>
        </mat-form-field>
      </label>
    </div>
    <label>
      Observaciones
      <textarea rows="2" [(ngModel)]="newFolderNotes" placeholder="Notas rÃ¡pidas"></textarea>
    </label>
    <div class="plan__new-actions">
      <button class="plan__secondary" type="button" (click)="toggleNewFolderForm()">Cancelar</button>
      <button class="plan__primary" type="button" (click)="createFolder()">Crear carpeta</button>
    </div>
  </section>

  <div class="plan__layout">
    <aside class="plan__folders">
      <div class="plan__section-header">
        <h3>Carpetas</h3>
        <span class="plan__hint" *ngIf="isLoadingFolders">Cargando...</span>
      </div>
      <div class="plan__folders-list" *ngIf="filteredFolders.length; else emptyFolders">
        <button
          class="plan__folder-card"
          type="button"
          *ngFor="let folder of filteredFolders"
          (click)="selectFolder(folder)"
          [class.plan__folder-card--active]="activeFolder?.id === folder.id">
          <div class="plan__folder-content">
            <p>{{ folder.name }}</p>
            <span>{{ folder.plannedDate ? (folder.plannedDate | date: 'longDate') : 'Sin fecha' }}</span>
            <span class="plan__folder-divider" aria-hidden="true"></span>
            <div class="plan__folder-meta">
              <span>{{ resolveFolderTrackLabel(folder) }}</span>
              <span class="plan__folder-dot">Â·</span>
              <span>{{ resolveFolderVisibility(folder) }}</span>
            </div>
          </div>
          <button class="plan__icon-button" type="button" aria-label="Eliminar carpeta"
            (click)="confirmDeleteFolder(folder); $event.stopPropagation();">
            <mat-icon aria-hidden="true">delete</mat-icon>
          </button>
        </button>
      </div>
      <ng-template #emptyFolders>
        <p class="plan__hint">No hay carpetas creadas todavÃ­a.</p>
      </ng-template>
    </aside>

    <section class="plan__details" *ngIf="activeFolder && editFolder; else emptyState">
      <div class="plan__details-header">
        <div>
          <p class="eyebrow">Carpeta abierta</p>
          <h2>Planifica tu salida</h2>
        </div>
        <button class="plan__primary" type="button" (click)="saveFolder()" [disabled]="isSavingFolder">
          Guardar
        </button>
      </div>

      <div class="plan__fields">
        <label>
          TÃ­tulo
          <input type="text" [(ngModel)]="editFolder.name">
        </label>
        <label>
          Fecha
          <input type="date" [(ngModel)]="editFolder.plannedDate" (ngModelChange)="onPlannedDateChange($event)">
        </label>
      </div>

      <label>
        Observaciones
        <textarea rows="3" [(ngModel)]="editFolder.observations" placeholder="AÃ±ade informaciÃ³n Ãºtil"></textarea>
      </label>

      <section class="plan__invite">
        <div class="plan__section-header">
          <h3>Invitar</h3>
        </div>
        <div class="plan__invite-row">
          <input type="text" [(ngModel)]="inviteQuery" placeholder="Busca por nombre o email"
            aria-label="Buscar usuarios">
          <button class="plan__secondary" type="button" (click)="searchInvite()">Buscar</button>
        </div>
        <p class="plan__hint" *ngIf="inviteStatusMessage">{{ inviteStatusMessage }}</p>
        <p class="plan__hint" *ngIf="!folderInvitations.length">
          No hay invitados. Esta carpeta no estÃ¡ compartida.
        </p>
        <div class="plan__invite-table-wrapper" *ngIf="folderInvitations.length">
          <table class="plan__invite-table" aria-label="Invitaciones enviadas">
            <thead>
              <tr>
                <th scope="col">Invitado</th>
                <th scope="col">Estado</th>
                <th scope="col">Actualizado</th>
                <th scope="col">Quitar</th>
                <th scope="col">Enviar</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let invitation of folderInvitations">
                <td>
                  <div class="plan__invite-name-row">
                    <span class="plan__invite-icon" aria-hidden="true">ðŸ‘¤</span>
                    <div>
                      <div class="plan__invite-name">{{ resolveInvitationLabel(invitation) }}</div>
                      <div class="plan__invite-email" *ngIf="resolveInvitationSecondary(invitation) as invitationSecondary">
                        {{ invitationSecondary }}
                      </div>
                    </div>
                  </div>
                </td>
                <td class="plan__center">
                  <div class="plan__invite-status">
                    <div>{{ resolveInvitationStatusLabel(invitation) }}</div>
                    <div class="plan__invite-status-date" *ngIf="resolveInvitationStatusDate(invitation) as statusDate">
                      {{ statusDate }}
                    </div>
                  </div>
                </td>
                <td class="plan__center">
                  <div class="plan__invite-status-date" *ngIf="resolveInvitationModifiedDate(invitation) as modifiedDate">
                    {{ modifiedDate }}
                  </div>
                </td>
                <td class="plan__center">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="removeInvitation(invitation)"
                    [disabled]="!canRemoveInvitation(invitation)">
                    Quitar
                  </button>
                </td>
                <td class="plan__center">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="resendInvitation(invitation)"
                    [disabled]="!canResendInvitation(invitation)">
                    Enviar invitaciÃ³n
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="plan__invite-table-wrapper" *ngIf="inviteResults.length">
          <table class="plan__invite-table" aria-label="Usuarios encontrados">
            <thead>
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Quitar</th>
                <th scope="col">Enviar</th>
                <th scope="col">Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of inviteResults">
                <td>
                  <div class="plan__invite-name-row">
                    <span class="plan__invite-icon" aria-hidden="true">ðŸ‘¤</span>
                    <div class="plan__invite-name">{{ resolveInviteNickname(user) }}</div>
                  </div>
                </td>
                <td class="plan__center">
                  <button class="plan__primary plan__primary--small" type="button"
                    (click)="revokeInvite(user)" [disabled]="!canRemoveInvite(user)">
                    Quitar
                  </button>
                </td>
                <td class="plan__center">
                  <button class="plan__primary plan__primary--small" type="button"
                    (click)="inviteUser(user)" [disabled]="!canSendInvite(user)">
                    Enviar
                  </button>
                </td>
                <td class="plan__center">{{ resolveInviteStatus(user) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="plan__tracks">
        <div class="plan__section-header">
          <h3>Tracks</h3>
          <button class="plan__secondary" type="button" (click)="onTrackImportClick()" [disabled]="isImportingTrack">
            Importar track
          </button>
          <input #trackInput type="file" accept=".gpx" hidden (change)="onTrackFileSelected($event)">
        </div>

        <p class="plan__hint" *ngIf="!editFolder.plannedDate">AÃ±ade una fecha para ver la predicciÃ³n del tiempo por
          track.</p>
        <p class="plan__hint" *ngIf="forecastNotice">{{ forecastNotice }}</p>

        <div class="plan__table-wrapper" *ngIf="tracks.length; else emptyTracks">
          <table class="plan__table" aria-label="Tracks planificados">
            <thead>
              <tr>
                <th scope="col">Track</th>
                <th scope="col">CÃ³mo llegar</th>
                <th scope="col">Votos</th>
                <th scope="col">Distancia</th>
                <th scope="col">Tiempo</th>
                <th scope="col">Ver ruta</th>
                <th scope="col">Meteo</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let track of tracks">
                <td>
                  <div class="plan__track-title">{{ track.name }}</div>
                  <span class="plan__track-meta">{{ track.startPopulation || 'UbicaciÃ³n por definir' }}</span>
                </td>
                <td class="plan__center">
                  <ng-container *ngIf="resolveMapsLink(track) as mapsLink; else noMapsLink">
                    <a class="plan__maps-link" [href]="mapsLink" target="_blank" rel="noopener noreferrer"
                      aria-label="Ver ubicaciÃ³n en Google Maps">
                      <mat-icon aria-hidden="true">location_on</mat-icon>
                    </a>
                  </ng-container>
                  <ng-template #noMapsLink>â€”</ng-template>
                </td>
                <td class="plan__center">{{ votesByTrackId.get(track.id) || 0 }}</td>
                <td class="plan__center">{{ formatDistance(track.distanceKm) }}</td>
                <td class="plan__center">{{ formatDuration(track.movingTimeSec) }}</td>
                <td class="plan__center">
                  <button class="plan__maps-link plan__animate-link" type="button" [disabled]="!canAnimateTrack(track)"
                    (click)="animateTrack(track)"
                    [attr.aria-label]="canAnimateTrack(track) ? 'Animar GPX en el mapa' : 'GPX no disponible'">
                    <mat-icon aria-hidden="true">directions_bike</mat-icon>
                  </button>
                </td>
                <td class="plan__center">
                  <div class="plan__weather" [attr.title]="resolveWeatherHint(track.id)">
                    <span class="plan__weather-icon" aria-hidden="true">
                      {{ resolveWeatherIcon(track.id) }}
                    </span>
                    <span class="plan__weather-temp">{{ resolveWeatherTemperature(track.id) }}</span>
                  </div>
                </td>
                <td class="plan__actions">
                  <div class="plan__actions-group">
                    <ng-container *ngIf="canVoteOnTracks(); else noVote">
                      <button class="plan__ghost" type="button" (click)="toggleVote(track)">
                        {{ resolveVoteLabel(track) }}
                      </button>
                    </ng-container>
                    <ng-template #noVote>
                      <span class="plan__muted">â€”</span>
                    </ng-template>
                    <button class="plan__icon-button plan__icon-button--danger" type="button"
                      (click)="confirmDeleteTrack(track)" aria-label="Eliminar track">
                      <mat-icon aria-hidden="true">delete</mat-icon>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #emptyTracks>
          <p class="plan__hint">TodavÃ­a no hay tracks en esta carpeta.</p>
        </ng-template>
      </section>
    </section>

  </div>
</div>

<ng-template #emptyState>
  <div class="plan__empty">
    <h2>Crea una carpeta para empezar</h2>
    <p>Organiza tracks, invita a tu grupo y empieza a votar rutas.</p>
  </div>
</ng-template>
