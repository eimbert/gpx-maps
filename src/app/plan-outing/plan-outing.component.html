<div class="plan">
  <header class="plan__toolbar">
    <div class="plan__toolbar-left">
      <button class="plan__home-button" type="button" (click)="goHome()" aria-label="Volver al inicio">
        <mat-icon aria-hidden="true">home</mat-icon>
        Inicio
      </button>
      <div class="plan__search">
        <mat-icon aria-hidden="true">search</mat-icon>
        <input type="text" [(ngModel)]="folderSearch" (input)="applyFolderFilter()" placeholder="Buscar salida"
          aria-label="Buscar salida">
      </div>
    </div>
    <div class="plan__toolbar-actions">
      <button class="plan__primary" type="button" (click)="toggleNewFolderForm()">
        Nueva salida
      </button>
    </div>
  </header>

  <section class="plan__new" *ngIf="showNewFolderForm">
    <div class="plan__new-fields">
      <label>
        Nombre de salida
        <input type="text" [(ngModel)]="newFolderName" placeholder="Ej: Salida al Montseny">
      </label>
      <label>
        Fecha prevista

        <input type="date" [(ngModel)]="newFolderDate"> <!--  (ngModelChange)="onPlannedDateChange($event)"> -->

        <!-- <mat-form-field  class="plan__date-field" appearance="fill">
          <input matInput [matDatepicker]="newFolderPicker" [(ngModel)]="newFolderDate">
          <mat-datepicker-toggle matIconSuffix [for]="newFolderPicker"></mat-datepicker-toggle>
          <mat-datepicker #newFolderPicker></mat-datepicker>
        </mat-form-field> -->
      </label>
    </div>
    <label>
      Observaciones
      <textarea rows="2" [(ngModel)]="newFolderNotes" placeholder="Notas rÃ¡pidas"></textarea>
    </label>
    <div class="plan__new-actions">
      <button class="plan__secondary" type="button" (click)="toggleNewFolderForm()">Cancelar</button>
      <button class="plan__primary" type="button" (click)="createFolder()">Crear salida</button>
    </div>
  </section>

  <div class="plan__layout">
    <aside class="plan__folders">
      <div class="plan__section-header">
        <h3>Salidas planificadas</h3>
        <div class="plan__section-actions">
          <button
            class="plan__notification-button"
            type="button"
            aria-label="Avisos de salidas"
            [disabled]="!pendingMessages.length"
            [class.plan__notification-button--active]="pendingMessages.length"
            (click)="togglePendingMessages()"
            [attr.aria-expanded]="showPendingMessages">
            <mat-icon aria-hidden="true">notifications</mat-icon>
            <span class="plan__notification-count" *ngIf="pendingMessages.length">
              {{ pendingMessages.length }}
            </span>
          </button>
          <span class="plan__hint" *ngIf="isLoadingFolders">Cargando...</span>
        </div>
      </div>
      <div class="plan__folders-list" *ngIf="filteredFolders.length; else emptyFolders">
        <button
          class="plan__folder-card"
          type="button"
          *ngFor="let folder of filteredFolders"
          (click)="selectFolder(folder)"
          [class.plan__folder-card--active]="activeFolder?.id === folder.id"
          [class.plan__folder-card--owner]="isFolderOwner(folder)"
          [class.plan__folder-card--guest]="!isFolderOwner(folder)">
          <div class="plan__folder-content">
            <p>{{ folder.name }}</p>
            <span>{{ folder.plannedDate ? (folder.plannedDate | date: 'longDate') : 'Sin fecha' }}</span>
            <span class="plan__folder-divider" aria-hidden="true"></span>
            <div class="plan__folder-meta">
              <span>{{ resolveFolderTrackLabel(folder) }}</span>
              <span class="plan__folder-dot">Â·</span>
              <span>{{ resolveFolderVisibility(folder) }}</span>
            </div>
          </div>
          <button *ngIf="isFolderOwner(folder)" class="plan__icon-button plan__icon-button--danger" type="button" aria-label="Eliminar carpeta"
            (click)="confirmDeleteFolder(folder); $event.stopPropagation();">
            <mat-icon aria-hidden="true">delete</mat-icon>
          </button>
        </button>
      </div>
      <ng-template #emptyFolders>
        <p class="plan__hint">No hay salidas creadas todavÃ­a.</p>
      </ng-template>
    </aside>

    <section class="plan__details" *ngIf="activeFolder && editFolder; else emptyState">
      <div class="plan__details-header">
        <div>
          <p class="eyebrow">Salida abierta</p>
          <h2>Planifica tu salida</h2>
        </div>
        <button class="plan__primary" type="button" (click)="saveFolder()" [disabled]="isSavingFolder">
          Guardar
        </button>
      </div>

      <div class="plan__fields">
        <label>
          TÃ­tulo
          <input type="text" [(ngModel)]="editFolder.name">
        </label>
        <label>
          Fecha
          <input type="date" [(ngModel)]="editFolder.plannedDate" (ngModelChange)="onPlannedDateChange($event)">
        </label>
      </div>

      <label>
        Observaciones
        <textarea rows="3" [(ngModel)]="editFolder.observations" placeholder="AÃ±ade informaciÃ³n Ãºtil"></textarea>
      </label>

      <section class="plan__invite">
        <div class="plan__section-header">
          <h3>Invitar</h3>
        </div>
        <div class="plan__invite-row">
          <input type="text" [(ngModel)]="inviteQuery" placeholder="Busca por nick o email"
            aria-label="Buscar usuarios">
          <button class="plan__secondary" type="button" (click)="searchInvite()">Buscar</button>
        </div>
        <p class="plan__hint" *ngIf="inviteStatusMessage">{{ inviteStatusMessage }}</p>
        <div class="plan__invite-table-wrapper" *ngIf="inviteSearchResults.length">
          <table class="plan__invite-table" aria-label="Resultados de bÃºsqueda de usuarios">
            <thead>
              <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Estado</th>
                <th scope="col" *ngIf="canManageInvitations()"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of inviteSearchResults">
                <td>
                  <div class="plan__invite-name-row">
                    <span class="plan__invite-icon" aria-hidden="true">ðŸ‘¤</span>
                    <div>
                      <div class="plan__invite-name">{{ resolveInviteNickname(user) }}</div>
                      <div class="plan__invite-email" *ngIf="resolveInviteSecondary(user) as inviteSecondary">{{ inviteSecondary }}</div>
                    </div>
                  </div>
                </td>
                <td class="plan__center">{{ resolveInviteStatus(user) }}</td>
                <td class="plan__center" *ngIf="canManageInvitations()">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="inviteUser(user)"
                    [disabled]="!canSendInvite(user)">
                    {{ resolveInviteActionLabel(user) }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="plan__hint" *ngIf="!folderInvitations.length">
          No hay invitados. Esta salida no estÃ¡ compartida.
        </p>
        <div class="plan__invite-table-wrapper" *ngIf="folderInvitations.length">
          <table class="plan__invite-table" aria-label="Invitaciones enviadas">
            <thead>
              <tr>
                <th scope="col">Invitado</th>
                <th scope="col">Estado</th>
                <th scope="col">Actualizado</th>
                <th scope="col" *ngIf="canManageInvitations()"></th>
                <th scope="col" *ngIf="canManageInvitations()"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let invitation of folderInvitations">
                <td>
                  <div class="plan__invite-name-row">
                    <span class="plan__invite-icon" aria-hidden="true">ðŸ‘¤</span>
                    <div>
                      <div class="plan__invite-name">{{ resolveInvitationLabel(invitation) }}</div>
                      <div class="plan__invite-email" *ngIf="resolveInvitationSecondary(invitation) as invitationSecondary">
                        {{ invitationSecondary }}
                      </div>
                    </div>
                  </div>
                </td>
                <td class="plan__center">
                  <div class="plan__invite-status">
                    <div>{{ resolveInvitationStatusLabel(invitation) }}</div>
                    <div class="plan__invite-status-date" *ngIf="resolveInvitationStatusDate(invitation) as statusDate">
                      {{ statusDate }}
                    </div>
                  </div>
                </td>
                <td class="plan__center">
                  <div class="plan__invite-status-date" *ngIf="resolveInvitationModifiedDate(invitation) as modifiedDate">
                    {{ modifiedDate }}
                  </div>
                </td>
                <td class="plan__center" *ngIf="canManageInvitations()">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="removeInvitation(invitation)">
                    Quitar
                  </button>
                </td>
                <td class="plan__center" *ngIf="canManageInvitations()">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="resendInvitation(invitation)"
                    [disabled]="!canResendInvitation(invitation)">
                    {{ resolveResendInvitationLabel(invitation) }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="plan__tracks">
        <div class="plan__section-header">
          <h3>Tracks</h3>
          <div class="plan__section-actions">
            <button class="plan__secondary" type="button" (click)="viewSelectedTracks()"
              [disabled]="!hasSelectedTracks">
              Ver rutas seleccionadas
            </button>
            <button class="plan__secondary" type="button" (click)="onTrackImportClick()" [disabled]="isImportingTrack">
              Importar track
            </button>
            <input #trackInput type="file" accept=".gpx" hidden (change)="onTrackFileSelected($event)">
          </div>
        </div>

        <p class="plan__hint" *ngIf="!editFolder.plannedDate">AÃ±ade una fecha para ver la predicciÃ³n del tiempo por
          track.</p>
        <p class="plan__hint" *ngIf="forecastNotice">{{ forecastNotice }}</p>

        <div class="plan__difficulty-legend" *ngIf="tracks.length" aria-label="Escala de dureza">
          <span class="plan__difficulty-legend-title">Suave</span>
          <div class="plan__difficulty-scale" aria-hidden="true"></div>
          <span class="plan__difficulty-legend-title">Muy dura</span>
        </div>

        <div class="plan__table-wrapper" *ngIf="tracks.length; else emptyTracks">
          <table class="plan__table plan__table--desktop" aria-label="Tracks planificados">
            <thead>
              <tr>
                <th scope="col" class="plan__center plan__select-col">
                  <input
                    type="checkbox"
                    class="plan__track-checkbox"
                    [checked]="allSelectableTracksSelected"
                    [indeterminate]="hasSelectedTracks && !allSelectableTracksSelected"
                    [disabled]="!hasSelectableTracks"
                    (change)="toggleAllTracksSelection($any($event.target).checked)"
                    aria-label="Seleccionar todos los tracks con GPX disponible">
                </th>
                <th scope="col" style="text-align: left;">Track</th>
                <th scope="col">CÃ³mo llegar</th>
                <th scope="col">Votos</th>
                <th scope="col">Distancia</th>
                <th scope="col">Tiempo</th>
                <th scope="col">Desnivel
                  <span
                    class="plan__info-icon"
                    title="El desnivel puede ser un dato poco fiable dependiendo del GPS con el que se haya registrado la ruta."
                    aria-label="El desnivel puede ser un dato poco fiable dependiendo del GPS con el que se haya registrado la ruta."
                    role="img">
                    i
                  </span>
                </th>
                <th scope="col">Dureza</th>
                <th scope="col">Descargar</th>
                <th scope="col">Ver ruta</th>
                <th scope="col">Meteo</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let track of tracks">
                <td class="plan__center plan__select-col">
                  <input
                    type="checkbox"
                    class="plan__track-checkbox"
                    [checked]="selectedTrackIds.has(track.id)"
                    [disabled]="!canViewTrack(track)"
                    (change)="toggleTrackSelection(track, $any($event.target).checked)"
                    [attr.aria-label]="canViewTrack(track) ? 'Seleccionar ' + track.name : 'GPX no disponible'">
                </td>
                <td>
                  <!-- <div class="plan__track-title" style="text-align: left;">{{ track.name }}</div> -->
                  <ng-container *ngIf="track?.name as name">
                    <div
                      class="plan__track-title"
                      style="text-align:left; cursor:pointer"
                      [attr.title]="name.length > 20 ? name : null"
                    >
                      {{ name.length > 20 ? (name | slice:0:20) + 'â€¦' : name }}
                    </div>
                  </ng-container>


                  <span class="plan__track-meta" >{{ track.startPopulation || 'UbicaciÃ³n por definir' }}</span>
                </td>
                <td class="plan__center">
                  <ng-container *ngIf="resolveMapsLink(track) as mapsLink; else noMapsLink">
                    <a class="plan__maps-link" [href]="mapsLink" target="_blank" rel="noopener noreferrer"
                      aria-label="Ver ubicaciÃ³n en Google Maps">
                      <mat-icon aria-hidden="true">location_on</mat-icon>
                    </a>
                  </ng-container>
                  <ng-template #noMapsLink>â€”</ng-template>
                </td>
                <td class="plan__center">{{ votesByTrackId.get(track.id) || 0 }}</td>
                <td class="plan__center">{{ formatDistance(track.distanceKm) }}</td>
                <td class="plan__center">{{ formatDuration(track.movingTimeSec) }}</td>
                <td class="plan__center">{{ formatDesnivel(track.desnivel) }}</td>
                <td class="plan__center">
                  <ng-container *ngIf="getTrackDifficulty(track) as difficulty">
                    <span
                      class="plan__difficulty-pill"
                      [ngClass]="'plan__difficulty-pill--' + difficulty.key"
                      [attr.title]="difficulty.label + ': ' + difficulty.description"
                      [attr.aria-label]="'Dureza ' + difficulty.label">
                      <mat-icon class="plan__difficulty-icon" aria-hidden="true">landscape</mat-icon>
                    </span>
                  </ng-container>
                </td>
                <td class="plan__center">
                  <button class="plan__icon-button plan__icon-button--download" type="button"
                    [disabled]="!track.routeXml" (click)="downloadTrack(track)"
                    [attr.aria-label]="track.routeXml ? 'Descargar track' : 'GPX no disponible'">
                    <mat-icon aria-hidden="true">download</mat-icon>
                  </button>
                </td>
                <td class="plan__center">
                  <button class="plan__maps-link plan__animate-link" type="button" [disabled]="!canViewTrack(track)"
                    (click)="viewTrack(track)"
                    [attr.aria-label]="canViewTrack(track) ? 'Ver ruta en el mapa' : 'GPX no disponible'">
                    <mat-icon aria-hidden="true">map</mat-icon>
                  </button>
                </td>
                <td class="plan__center">
                  <div class="plan__weather" [attr.title]="resolveWeatherHint(track.id)">
                    <span class="plan__weather-icon" aria-hidden="true">
                      {{ resolveWeatherIcon(track.id) }}
                    </span>
                    <span class="plan__weather-temp">{{ resolveWeatherTemperature(track.id) }}</span>
                  </div>
                </td>
                <td class="plan__actions">
                  <div class="plan__actions-group">
                    <ng-container *ngIf="canVoteOnTracks(); else noVote">
                      <button class="plan__ghost" type="button" (click)="toggleVote(track)">
                        {{ resolveVoteLabel(track) }}
                      </button>
                    </ng-container>
                    <ng-template #noVote>
                      <span class="plan__muted">â€”</span>
                    </ng-template>
                    <button *ngIf="canDeleteTracks(); else cannotDeleteTrack"
                      class="plan__icon-button plan__icon-button--danger" type="button"
                      (click)="confirmDeleteTrack(track)" aria-label="Eliminar track">
                      <mat-icon aria-hidden="true">delete</mat-icon>
                    </button>
                    <ng-template #cannotDeleteTrack>
                      <span class="plan__muted">â€”</span>
                    </ng-template>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="plan__track-cards" aria-label="Tracks planificados en mÃ³vil">
            <article class="plan__track-card" *ngFor="let track of tracks">
              <header class="plan__track-card-header">
                <div class="plan__track-card-title-wrap">
                  <input
                    type="checkbox"
                    class="plan__track-checkbox"
                    [checked]="selectedTrackIds.has(track.id)"
                    [disabled]="!canViewTrack(track)"
                    (change)="toggleTrackSelection(track, $any($event.target).checked)"
                    [attr.aria-label]="canViewTrack(track) ? 'Seleccionar ' + track.name : 'GPX no disponible'">
                  <div>
                    <div class="plan__track-title">{{ track.name }}</div>
                    <span class="plan__track-meta">{{ track.startPopulation || 'UbicaciÃ³n por definir' }}</span>
                  </div>
                </div>
                <div class="plan__track-card-votes">{{ votesByTrackId.get(track.id) || 0 }} votos</div>
              </header>

              <div class="plan__track-card-grid">
                <div><span class="plan__track-card-label">Distancia</span>{{ formatDistance(track.distanceKm) }}</div>
                <div><span class="plan__track-card-label">Tiempo</span>{{ formatDuration(track.movingTimeSec) }}</div>
                <div><span class="plan__track-card-label">Desnivel</span>{{ formatDesnivel(track.desnivel) }}</div>
                <div>
                  <span class="plan__track-card-label">Dureza</span>
                  <ng-container *ngIf="getTrackDifficulty(track) as difficulty">
                    <span
                      class="plan__track-card-difficulty"
                      [attr.title]="difficulty.label + ': ' + difficulty.description"
                      [attr.aria-label]="'Dureza ' + difficulty.label">
                      <span class="plan__difficulty-pill" [ngClass]="'plan__difficulty-pill--' + difficulty.key">
                        <mat-icon class="plan__difficulty-icon" aria-hidden="true">landscape</mat-icon>
                      </span>
                      <span>{{ difficulty.label }}</span>
                    </span>
                  </ng-container>
                </div>
                <div class="plan__track-card-weather">
                  <span class="plan__track-card-label">Meteo</span>
                  <span>{{ resolveWeatherIcon(track.id) }} {{ resolveWeatherTemperature(track.id) }}</span>
                </div>
              </div>

              <div class="plan__track-card-actions">
                <ng-container *ngIf="resolveMapsLink(track) as mapsLink; else noMobileMapsLink">
                  <a class="plan__maps-link" [href]="mapsLink" target="_blank" rel="noopener noreferrer"
                    aria-label="Ver ubicaciÃ³n en Google Maps">
                    <mat-icon aria-hidden="true">location_on</mat-icon>
                  </a>
                </ng-container>
                <ng-template #noMobileMapsLink>
                  <span class="plan__muted">â€”</span>
                </ng-template>
                <button class="plan__icon-button plan__icon-button--download" type="button"
                  [disabled]="!track.routeXml" (click)="downloadTrack(track)"
                  [attr.aria-label]="track.routeXml ? 'Descargar track' : 'GPX no disponible'">
                  <mat-icon aria-hidden="true">download</mat-icon>
                </button>
                <button class="plan__maps-link plan__animate-link" type="button" [disabled]="!canViewTrack(track)"
                  (click)="viewTrack(track)"
                  [attr.aria-label]="canViewTrack(track) ? 'Ver ruta en el mapa' : 'GPX no disponible'">
                  <mat-icon aria-hidden="true">map</mat-icon>
                </button>
                <button class="plan__ghost" *ngIf="canVoteOnTracks(); else noVoteMobile" type="button" (click)="toggleVote(track)">
                  {{ resolveVoteLabel(track) }}
                </button>
                <ng-template #noVoteMobile>
                  <span class="plan__muted">â€”</span>
                </ng-template>
                <button *ngIf="canDeleteTracks(); else cannotDeleteTrackMobile"
                  class="plan__icon-button plan__icon-button--danger" type="button"
                  (click)="confirmDeleteTrack(track)" aria-label="Eliminar track">
                  <mat-icon aria-hidden="true">delete</mat-icon>
                </button>
                <ng-template #cannotDeleteTrackMobile>
                  <span class="plan__muted">â€”</span>
                </ng-template>
              </div>
            </article>
          </div>
        </div>
        <ng-template #emptyTracks>
          <p class="plan__hint">TodavÃ­a no hay tracks en esta carpeta.</p>
        </ng-template>
      </section>
    </section>

  </div>

  <div class="plan__notification-overlay" *ngIf="showPendingMessages">
    <button
      class="plan__notification-backdrop"
      type="button"
      aria-label="Cerrar avisos"
      (click)="togglePendingMessages()">
    </button>
    <section class="plan__notification-panel" role="dialog" aria-modal="true" aria-label="Avisos pendientes">
      <p class="plan__hint" *ngIf="isLoadingPendingMessages">Cargando avisos...</p>
      <p class="plan__hint" *ngIf="!isLoadingPendingMessages && !pendingMessages.length">
        No hay avisos pendientes.
      </p>
      <div class="plan__notification-table-wrapper" *ngIf="!isLoadingPendingMessages && pendingMessages.length">
        <table class="plan__notification-table" aria-label="Avisos pendientes">
          <thead>
            <tr >
              <th scope="col">Mensaje</th>
              <th scope="col">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pending of pendingMessages" style="border-bottom: 1px solid #fed7aa;">
              <td >
                <div class="plan__notification-text">{{ formatPendingMessageIntro(pending) }}</div>
                <div class="plan__notification-body">{{ pending.mensaje }}</div>
              </td>
              <td class="plan__notification-actions">
                <button
                  *ngIf="pending.tipoMsg === 0"
                  class="plan__secondary plan__secondary--small"
                  type="button"
                  (click)="markMessageAsSeen(pending)">
                  Visto
                </button>
                <ng-container *ngIf="pending.tipoMsg === 1">
                  <button
                    class="plan__primary plan__primary--small"
                    type="button"
                    (click)="updateMessageStatus(pending, 1)">
                    Aceptar
                  </button>
                  <button
                    class="plan__secondary plan__secondary--small"
                    type="button"
                    (click)="updateMessageStatus(pending, 0)">
                    Rechazar
                  </button>
                </ng-container>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<ng-template #emptyState>
  <div class="plan__empty">
    <h2>Crea una carpeta para empezar</h2>
    <p>Organiza tracks, invita a tu grupo y empieza a votar rutas.</p>
  </div>
</ng-template>
