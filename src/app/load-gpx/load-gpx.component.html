<div class="container">
  <section *ngIf="mode === 'routes'" class="load-wrapper">
    <header class="hero">
      <div>
        <h1>Organiza y Anima tus Tracks</h1>
        <p>Arrastra y suelta hasta {{ maxTracks }} recorridos o pulsa para seleccionarlos.</p>
        <p *ngIf="!isAuthenticated" class="guest-note">Sin sesi√≥n iniciada solo puedes cargar un archivo GPX a la vez.
        </p>
      </div>


    </header>
    <div style=" margin-top:28px;">
      <button type="button" class="event-action-button event-action-button--home hero__home" (click)="goHome()"
        matTooltip="Volver al inicio" aria-label="Volver al inicio">
        <mat-icon aria-hidden="true">home</mat-icon>
      </button>
    </div>

    <div class="dropzone" [class.dropzone--active]="isDragOver" (click)="triggerFileDialog()"
      (dragover)="onDragOver($event)" (dragleave)="onDragLeave()" (drop)="onDrop($event)">
      <input #fileInput type="file" accept=".gpx" [attr.multiple]="isAuthenticated ? '' : null"
        (change)="onFileInputChange($event)" hidden />

      <div class="dropzone__content">
        <div class="icon">üìÇ</div>
        <p class="title">Suelta aqu√≠ tus archivos GPX</p>
        <p class="subtitle">Tambi√©n puedes pulsar para abrir el selector</p>
        <button type="button" class="secondary" style="cursor: pointer;">A√±adir archivos</button>
      </div>
    </div>

    <section class="tracks" *ngIf="tracks.length">
      <h2>Tracks cargadas</h2>
      <ul class="file-list">
        <li class="file-item" *ngFor="let track of tracks; index as i">
          <span class="file-pill">{{ i + 1 }}</span>
          <div class="file-texts">
            <span class="file-name" [title]="track.fileName">{{ track.fileName }}</span>
            <span class="file-alias" [title]="track.name">{{ track.name }}</span>
          </div>
          <button type="button" style="cursor: pointer;" class="ghost" (click)="borrarFichero(i)">Quitar</button>
        </li>
      </ul>
    </section>

    <div class="action-row">
      <button (click)="iniciarVisualizacion()" [disabled]="!tracksCargados()" class="btn-start" matTooltip="Iniciar la animaci√≥n de los tracks cargados">
        <span>Iniciar</span>
        <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="btn-start__icon">
          <path d="M5 3l14 9-14 9V3z" fill="currentColor" />
        </svg>
      </button>
    </div>

    <section *ngIf="isAuthenticated && !isUserTracksPanelCollapsed" class="user-tracks">
      <div class="user-tracks__header">
        <div>
          <p class="eyebrow">Tracks disponibles</p>
        </div>
      </div>

      <div class="user-tracks__controls">
        <div class="user-tracks__filter">
          <mat-icon aria-hidden="true">search</mat-icon>
          <input type="text" [value]="userTracksFilter" (input)="onUserTracksFilter($any($event.target)?.value || '')"
            placeholder="Buscar por t√≠tulo, evento o ubicaci√≥n" aria-label="Filtrar tracks guardadas">
        </div>

        <!-- botones de totales -->
        <div class="user-tracks__tabs">
          <button type="button" class="user-tracks__tab"
            [class.user-tracks__tab--active]="activeUserTracksTab === 'personal'" (click)="setUserTracksTab('personal')"
            aria-label="Ver tus tracks personales">
            <span>Tus tracks</span>
            <span class="user-tracks__tab-count">{{ getUserTrackRows('personal').length }}</span>
          </button>
          <button type="button" class="user-tracks__tab"
            [class.user-tracks__tab--active]="activeUserTracksTab === 'events'" (click)="setUserTracksTab('events')"
            aria-label="Ver tus tracks de eventos">
            <span>Tus tracks en eventos</span>
            <span class="user-tracks__tab-count">{{ getUserTrackRows('events').length }}</span>
          </button>
          <button type="button" class="user-tracks__tab"
            [class.user-tracks__tab--active]="activeUserTracksTab === 'shared'" (click)="setUserTracksTab('shared')"
            aria-label="Ver tracks de otros usuarios">
            <span>Tracks otros usuarios</span>
            <span class="user-tracks__tab-count">{{ getUserTrackRows('shared').length }}</span>
          </button>
        </div>

        <button *ngIf="activeUserTracksTab === 'personal'" type="button" class="cloud-upload"
          (click)="openStandaloneUploadDialog()" [disabled]="standaloneUploadInProgress">
          <mat-icon aria-hidden="true">cloud_upload</mat-icon>
          <span>Subir track</span>
        </button>
      </div>

      <p class="muted" *ngIf="activeTracksLoading">{{ activeTracksLoadingLabel }}</p>
      <p class="muted" *ngIf="!activeTracksLoading && !getUserTrackRows(activeUserTracksTab).length">{{activeTracksEmptyMessage }}</p>

      <div class="user-tracks__panel" *ngIf="!activeTracksLoading && getUserTrackRows(activeUserTracksTab).length">
        <div class="user-tracks__table-toolbar">
          <div class="user-tracks__counts">
            <span class="user-tracks__count">{{ filteredUserTracks.length }} tracks</span>
            <span class="user-tracks__range" *ngIf="groupedUserTracks.length && groupedUserTracks.length !== paginatedUserTracks.length">
              Provincias {{ userTracksRangeStart }}-{{ userTracksRangeEnd }} de {{ groupedUserTracks.length }}
            </span>
          </div>
        </div>

        <div class="user-tracks__groups" *ngIf="paginatedUserTracks.length; else emptyGroups">
          <table class="tabla-rutas" aria-label="Tracks guardadas agrupadas por provincia">
            <thead>
              <tr class="head-tabla">
                <th scope="col" style="text-align: left; padding-left: 45px;">Provincia</th>
                <th scope="col">Tracks</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let group of paginatedUserTracks">
                <tr>
                  <td>
                    <button type="button" class="user-tracks__expand" (click)="toggleProvinceExpansion(group.province)"
                      [attr.aria-expanded]="isProvinceExpanded(group.province)"
                      [attr.aria-label]="isProvinceExpanded(group.province) ? 'Ocultar tracks en ' + group.province : 'Mostrar tracks en ' + group.province">
                      <mat-icon class="user-tracks__expand-icon" aria-hidden="true">{{isProvinceExpanded(group.province) ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>
                    </button>
                    <span class="user-tracks__population-name">{{ group.province }}
                      <span class="user-tracks__population-meta">‚Äî <span class="user-tracks__population-community">({{group.autonomousCommunity || '‚Äî' }})</span></span>
                    </span>
                    <!-- <span class="user-tracks__population-name-mobile">Grupo de rutas</span> -->
                  </td>
                  <td class="user-tracks__metric user-tracks__metric--center">{{ group.count }}</td>
                </tr>
                <tr *ngIf="isProvinceExpanded(group.province)" class="user-tracks__routes-row">
                  <td colspan="2">
                    <div style="width: 90%; margin: 0 auto;">
                      <table class="user-tracks__nested-table user-tracks__nested-table--desktop" [attr.aria-label]="'Tracks en ' + group.province">
                        <thead>
                          <tr
                            style="border-style:solid; border-width: 1px; border-color: rgb(231, 228, 228); font-size: 11px;">
                            <th scope="col">Track</th>
                            <th scope="col" *ngIf="activeUserTracksTab === 'shared'">Nickname</th>
                            <th scope="col" *ngIf="activeUserTracksTab === 'shared'">Tipo bici</th>
                            <th scope="col">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('year')" aria-label="Ordenar por a√±o">A√±o 
                                <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('year')}}</span>
                              </button>
                            </th>
                            <th scope="col" style="text-align: left;">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('autonomousCommunity')" aria-label="Ordenar por comunidad">
                                Comunidad <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('autonomousCommunity') }}</span>
                              </button>
                            </th>
                            <th scope="col" style="text-align: left;">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('province')"
                                aria-label="Ordenar por provincia">
                                Provincia <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('province') }}</span>
                              </button>
                            </th>
                            <th scope="col" style="text-align: left;">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('population')" aria-label="Ordenar por poblaci√≥n">
                                Poblaci√≥n <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('population') }}</span>
                              </button>
                            </th>
                            <th scope="col" class="user-tracks__action-col">C√≥mo llegar</th>
                            <th scope="col">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('distanceKm')" aria-label="Ordenar por distancia">
                                Distancia <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('distanceKm') }}</span>
                              </button>
                            </th>
                            <th scope="col">
                              <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('timeSeconds')"
                                aria-label="Ordenar por tiempo en movimiento">Tiempo <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('timeSeconds') }}</span>
                              </button>
                            </th>
                            <th scope="col">
                              <button type="button" class="user-tracks__sort"
                                (click)="sortUserTracksBy('totalTimeSeconds')" aria-label="Ordenar por tiempo total">
                                Tiempo total <span class="user-tracks__sort-indicator">{{resolveUserTracksSortIndicator('totalTimeSeconds') }}</span>
                              </button>
                            </th>
                            <th scope="col" class="user-tracks__action-col">Descargar</th>
                            <th scope="col" class="user-tracks__action-col">Animar</th>
                            <th scope="col" class="user-tracks__action-col">Planificar salida</th>
                            <th scope="col" class="user-tracks__action-col">Eliminar</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- <tr style="border-style:solid; border-width: 0.5px; border-color: lightgrey;" *ngFor="let row of group.routes" >  -->
                          <tr class="nested-row"
                            style="border-style:solid; border-width: 0.5px; border-color: lightgrey;"
                            *ngFor="let row of group.routes">
                            <td> <!-- class="user-tracks__title-col" -->
                              <div *ngIf="row.eventName && row.eventName !== '-'">
                                <span style="color: rgb(8, 8, 158);">{{ row.eventName }} (E)</span>
                              </div>
                              <div *ngIf="row.title">
                                <span class="user-tracks__title user-tracks__title--title">{{ row.title }}</span>
                                <!-- class="user-tracks__label"-->
                              </div>
                              <span *ngIf="!row.title && (!row.eventName || row.eventName === '-')">‚Äî</span>
                            </td>
                            <td *ngIf="activeUserTracksTab === 'shared'">{{ row.nickname || '‚Äî' }}</td>
                            <td *ngIf="activeUserTracksTab === 'shared'">{{ row.bikeType || '‚Äî' }}</td>
                            <td style="text-align: center;">{{ row.year || '-' }}</td>
                            <td style="text-align: left;">{{ row.autonomousCommunity || '‚Äî' }}</td>
                            <td style="text-align: left;">{{ row.province || '‚Äî' }}</td>
                            <td>{{ row.population || '‚Äî' }}</td>
                            <td class="user-tracks__action-col">
                              <a class="user-tracks__maps-link user-tracks__maps-link--icon"
                                [href]="row.googleMapsLink" target="_blank" rel="noopener noreferrer"
                                aria-label="C√≥mo llegar al inicio de la ruta en Google Maps"
                                title="C√≥mo llegar al inicio de la ruta" (click)="$event.stopPropagation()">
                                <mat-icon aria-hidden="true">directions_car</mat-icon>
                                <mat-icon class="user-tracks__maps-pin" aria-hidden="true">location_on</mat-icon>
                              </a>
                            </td>
                            <td class="user-tracks__metric user-tracks__metric--right">{{ row.distanceLabel }}</td>
                            <td class="user-tracks__metric user-tracks__metric--center">{{ row.movingTimeLabel }}</td>
                            <td class="user-tracks__metric user-tracks__metric--center">{{ row.totalTimeLabel }}</td>
                            <td class="user-tracks__action-col">
                              <!-- <button type="button" class="ghost ghost--small user-tracks__icon-button" [disabled]="isDownloadingTrack(row)" (click)="downloadUserTrack(row)" [attr.aria-label]="isDownloadingTrack(row) ? 'Descargando track' : 'Descargar track'"> -->
                              <mat-icon aria-hidden="true" style="color: blue; cursor: pointer;"
                                (click)="downloadUserTrack(row)"
                                [attr.aria-label]="isDownloadingTrack(row) ? 'Descargando track' : 'Descargar track'">{{
                                isDownloadingTrack(row) ? 'downloading' : 'file_download' }}</mat-icon>
                              <!-- </button> -->
                            </td>
                            <td class="user-tracks__action-col">
                              <!-- <button type="button" class="ghost ghost--small user-tracks__icon-button" (click)="animateUserTrack(row)" aria-label="Animar track"> -->
                              <mat-icon aria-hidden="true" style="color: orange; cursor: pointer;"
                                (click)="animateUserTrack(row)">play_arrow</mat-icon>
                              <!-- </button> -->
                            </td>
                            <td class="user-tracks__action-col">
                              <mat-icon aria-hidden="true" style="color: #7b1fa2; cursor: pointer;"
                                (click)="planUserTrack(row)"
                                [attr.aria-label]="isPlanningTrack(row) ? 'Guardando planificaci√≥n' : 'Planificar salida'">{{
                                isPlanningTrack(row) ? 'hourglass_top' : 'event_available' }}</mat-icon>
                            </td>
                            <td class="user-tracks__action-col">
                              <!-- <button type="button" class="ghost ghost--small ghost--danger user-tracks__icon-button" [disabled]="isDeletingTrack(row)" (click)="confirmDeleteUserTrack(row)" [attr.aria-label]="isDeletingTrack(row) ? 'Eliminando track' : 'Eliminar track'"> -->
                              <mat-icon *ngIf="row.canDelete" aria-hidden="true" style="color: red; cursor: pointer;"
                                (click)="confirmDeleteUserTrack(row)"
                                [attr.aria-label]="isDeletingTrack(row) ? 'Eliminando track' : 'Eliminar track'">{{
                                isDeletingTrack(row) ? 'hourglass_top' : 'delete' }}</mat-icon>
                              <!-- </button> -->
                            </td>
                          </tr>
                        </tbody>
                      </table>

                      <div class="user-tracks__mobile-list" [attr.aria-label]="'Tracks en ' + group.province + ' (m√≥vil)'">
                        <article class="user-tracks__mobile-card" *ngFor="let row of group.routes">
                          <header class="user-tracks__mobile-header">
                            <div>
                              <div *ngIf="row.eventName && row.eventName !== '-'" class="user-tracks__mobile-event">
                                {{ row.eventName }} (E)
                              </div>
                              <div class="user-tracks__mobile-title">{{ row.title || 'Sin t√≠tulo' }}</div>
                            </div>
                            <span class="user-tracks__mobile-year">{{ row.year || '-' }}</span>
                          </header>

                          <div class="user-tracks__mobile-grid">
                            <div class="user-tracks__mobile-item" *ngIf="activeUserTracksTab === 'shared'">
                              <span class="user-tracks__mobile-label">Nickname</span>
                              <span>{{ row.nickname || '‚Äî' }}</span>
                            </div>
                            <div class="user-tracks__mobile-item" *ngIf="activeUserTracksTab === 'shared'">
                              <span class="user-tracks__mobile-label">Tipo bici</span>
                              <span>{{ row.bikeType || '‚Äî' }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Comunidad</span>
                              <span>{{ row.autonomousCommunity || '‚Äî' }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Provincia</span>
                              <span>{{ row.province || '‚Äî' }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Poblaci√≥n</span>
                              <span>{{ row.population || '‚Äî' }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Distancia</span>
                              <span>{{ row.distanceLabel }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Tiempo</span>
                              <span>{{ row.movingTimeLabel }}</span>
                            </div>
                            <div class="user-tracks__mobile-item">
                              <span class="user-tracks__mobile-label">Tiempo total</span>
                              <span>{{ row.totalTimeLabel }}</span>
                            </div>
                          </div>

                          <div class="user-tracks__mobile-actions">
                            <a class="user-tracks__maps-link user-tracks__maps-link--icon"
                              [href]="row.googleMapsLink" target="_blank" rel="noopener noreferrer"
                              aria-label="C√≥mo llegar al inicio de la ruta en Google Maps"
                              title="C√≥mo llegar al inicio de la ruta" (click)="$event.stopPropagation()">
                              <mat-icon aria-hidden="true">directions_car</mat-icon>
                              <mat-icon class="user-tracks__maps-pin" aria-hidden="true">location_on</mat-icon>
                            </a>
                            <mat-icon aria-hidden="true" style="color: blue; cursor: pointer;"
                              (click)="downloadUserTrack(row)"
                              [attr.aria-label]="isDownloadingTrack(row) ? 'Descargando track' : 'Descargar track'">{{
                              isDownloadingTrack(row) ? 'downloading' : 'file_download' }}</mat-icon>
                            <mat-icon aria-hidden="true" style="color: orange; cursor: pointer;"
                              (click)="animateUserTrack(row)">play_arrow</mat-icon>
                            <mat-icon aria-hidden="true" style="color: #7b1fa2; cursor: pointer;"
                              (click)="planUserTrack(row)"
                              [attr.aria-label]="isPlanningTrack(row) ? 'Guardando planificaci√≥n' : 'Planificar salida'">{{
                              isPlanningTrack(row) ? 'hourglass_top' : 'event_available' }}</mat-icon>
                            <mat-icon *ngIf="row.canDelete" aria-hidden="true" style="color: red; cursor: pointer;"
                              (click)="confirmDeleteUserTrack(row)"
                              [attr.aria-label]="isDeletingTrack(row) ? 'Eliminando track' : 'Eliminar track'">{{
                              isDeletingTrack(row) ? 'hourglass_top' : 'delete' }}</mat-icon>
                          </div>
                        </article>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <ng-template #emptyGroups>
          <div class="user-tracks__empty">No hay tracks que coincidan con la b√∫squeda.</div>
        </ng-template>

        <div class="user-tracks__pagination">
          <div class="user-tracks__pagination-rows">
            <label for="userTracksRows">Filas:</label>
            <select id="userTracksRows" [value]="userTracksRows"
              (change)="onUserTracksRowsChange($any($event.target).value)">
              <option *ngFor="let option of userTracksRowsOptions" [value]="option">{{ option }}</option>
            </select>
          </div>
          <div class="user-tracks__pagination-controls">
            <button type="button" style="cursor: pointer;" class="ghost ghost--small" (click)="changeUserTracksPage(-1)"
              [disabled]="userTracksPage === 0 || !userTracksPageCount">Anterior</button>
            <span class="user-tracks__page-indicator">
              P√°gina {{ userTracksPageCount ? userTracksPage + 1 : 0 }} / {{ userTracksPageCount || 0 }}
            </span>
            <button type="button" style="cursor: pointer;" class="ghost ghost--small" (click)="changeUserTracksPage(1)"
              [disabled]="!userTracksPageCount || userTracksPage + 1 >= userTracksPageCount">Siguiente</button>
          </div>
        </div>
      </div>
    </section>
  </section>

  <section *ngIf="mode === 'events'" class="events-wrapper">
    <header class="hero events-hero">
      <div>
        <p style="color: beige; padding-bottom: 10px;">Ranking social</p>
        <h1 style="color: lightyellow;">Elige evento, sube tu track y anima la carrera</h1>
        <p style="color: beige;">Explora recorridos</p>
        <p style="color: beige;">S√∫mate al ranking por categor√≠a</p>
        <p style="color: beige;">Compara tu GPX con otros riders</p>
      </div>
    </header>
    <div *ngIf="!isAuthenticated" class="events-locked">
      <p class="events-locked__title">Explora y anima eventos sin registrarte.</p>
      <p class="muted">Inicia sesi√≥n o reg√≠strate desde la pantalla principal si quieres subir o gestionar tracks.</p>
      <button type="button" class="secondary" (click)="goHome()">Volver a la pantalla principal</button>
    </div>

    <div class="events-actions" style="margin-top:28px;">
      <div class="events-actions__buttons">
        <button type="button" class="event-action-button event-action-button--home" (click)="goHome()"
          matTooltip="Volver al inicio" aria-label="Volver al inicio">
          <mat-icon aria-hidden="true">home</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openUploadTrackDialog()" matTooltip="Subir track"
          aria-label="Subir track">
          <mat-icon aria-hidden="true">file_upload</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openCreateEventDialog()" matTooltip="Crear evento"
          aria-label="Crear evento">
          <mat-icon aria-hidden="true">add_circle</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openEventSearch()" matTooltip="Lista de eventos"
          aria-label="Lista de eventos">
          <mat-icon aria-hidden="true">format_list_bulleted</mat-icon>
        </button>
        <button type="button" class="event-action-button" [disabled]="!canDeleteSelectedEvent()"
          (click)="deleteSelectedEvent()" matTooltip="Eliminar evento" aria-label="Eliminar evento">
          <mat-icon aria-hidden="true">delete</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openMyTracksDialog()" matTooltip="Mis tracks"
          aria-label="Mis tracks">
          <mat-icon aria-hidden="true">folder_shared</mat-icon>
        </button>
      </div>
    </div>
    <input #masterGpxInput type="file" accept=".gpx" hidden (change)="onMasterGpxFileChange($event)" />

    <ng-container *ngIf="events.length; else emptyEvents">
      <section class="events-layout">
        <div class="events-layout__left">
          <div class="events-carousel">
            <div class="carousel-window">
              <div class="carousel-track">

                <article *ngFor="let event of events; index as i" class="event-card event-card--carousel"
                  [class.event-card--active]="event.id === selectedEventId"
                  [class.event-card--current]="i === carouselIndex" (click)="handleCarouselSelection(event.id)">
                  <div class="event-card__content event-card__content--stacked">
                    <div class="event-card__info">
                      <p class="eyebrow">{{ event.year }}</p>
                      <div class="event-card__title-row">
                        <div class="event-logo event-logo--badge">
                          <ng-container *ngIf="event.logoBlob; else logoPlaceholderSmall">
                            <img [src]="getEventLogo(event)" [alt]="event.name + ' logo'" />
                          </ng-container>
                          <ng-template #logoPlaceholderSmall>
                            <span class="muted">Logo</span>
                          </ng-template>
                        </div>
                        <div>
                          <p class="event-card__title">{{ event.name }}</p>
                          <p class="muted event-card__subtitle">{{ getEventLocation(event) || 'Ubicaci√≥n pendiente' }}</p>
                        </div>
                      </div>
                      <div class="carousel-controls carousel-controls--inline">
                        <button type="button" class="carousel-button" (click)="prevEvent(true); $event.stopPropagation()" aria-label="Evento anterior"
                          matTooltip="Ir al evento anterior del carrusel">
                          <mat-icon aria-hidden="true">skip_previous</mat-icon>
                        </button>
                        <button type="button" class="carousel-button carousel-button--primary" (click)="toggleCarouselPlayback(); $event.stopPropagation()"
                          [attr.aria-label]="isCarouselPaused ? 'Reanudar carrusel' : 'Pausar carrusel'"
                          [matTooltip]="isCarouselPaused ? 'Reanudar reproducci√≥n autom√°tica' : 'Pausar reproducci√≥n autom√°tica'">
                          <mat-icon aria-hidden="true">{{ isCarouselPaused ? 'play_arrow' : 'pause' }}</mat-icon>
                        </button>
                        <button type="button" class="carousel-button" (click)="nextEvent(true); $event.stopPropagation()" aria-label="Siguiente evento"
                          matTooltip="Avanzar al siguiente evento del carrusel">
                          <mat-icon aria-hidden="true">skip_next</mat-icon>
                        </button>
                      </div>
                    </div>

                    <div class="event-card__map"
                      [style.--event-map-url]="eventVisuals[event.id].mapTileUrl ? 'url(' + eventVisuals[event.id].mapTileUrl + ')' : 'none'">
                      <ng-container *ngIf="eventVisuals[event.id]?.trackPath; else missingTrack">
                        <svg viewBox="0 0 320 240" preserveAspectRatio="none" class="track-drawing">
                          <polyline [attr.points]="eventVisuals[event.id].trackPath"></polyline>
                        </svg>
                      </ng-container>
                      <ng-template #missingTrack>
                        <div class="no-track">
                          <p class="muted">No se dispone de track</p>
                          <button *ngIf="canUploadMasterGpx(event)" type="button" class="secondary"
                            (click)="promptMasterGpxUpload(event.id); $event.stopPropagation();">
                            Subir track
                          </button>
                        </div>
                      </ng-template>
                    </div>

                    <div class="event-profile">
                      <ng-container *ngIf="eventVisuals[event.id]?.profile?.points; else noProfile">
                        <div class="profile-chart-wrapper">
                          <svg [attr.viewBox]="'0 0 ' + profileWidth + ' ' + profileHeight" preserveAspectRatio="none"
                            class="profile-chart">
                            <g class="grid-lines">
                              <ng-container *ngFor="let line of eventVisuals[event.id].profile?.gridLines">
                                <line x1="0" [attr.y1]="line.y" [attr.y2]="line.y" [attr.x2]="profileWidth" />
                                <text class="grid-label" x="4" [attr.y]="line.labelY">{{ line.label }}</text>
                              </ng-container>
                            </g>
                            <polyline [attr.points]="eventVisuals[event.id].profile?.points"></polyline>
                          </svg>
                          <div class="profile-legend" *ngIf="eventVisuals[event.id].profile as profile">
                            <div class="legend-row legend-row--altitude">
                              <span>Altura inicial:</span>
                              <strong>{{ profile.stats.initialElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row legend-row--altitude">
                              <span>Altura m√°xima:</span>
                              <strong>{{ profile.stats.maxElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row legend-row--altitude">
                              <span>Distancia:</span>
                              <strong>{{ profile.stats.distanceKm | number: '1.0-1' }} km</strong>
                            </div>
                            <!-- <div class="legend-row legend-row--tracks">
                              <span>Tracks:</span>
                              <strong>{{ event.tracks.length }}</strong>
                            </div> -->
                          </div>

                          <!-- <div class="legend-row legend-row--tracks" style="margin-top: 10px;"> -->
                            <!-- <span>Track maestro:</span> -->
                            <button type="button" class="cloud-download" style="margin-top: 10px;"
                              [disabled]="!hasMasterTrack(event) || isDownloadingMaster(event.id)"
                              (click)="downloadEventMaster(event, $event)">
                              <mat-icon aria-hidden="true">cloud_download</mat-icon>
                              <span *ngIf="!isDownloadingMaster(event.id)">Bajar track</span>
                              <span *ngIf="isDownloadingMaster(event.id)">Bajando...</span>
                            </button>
                          <!-- </div> -->

                        </div>
                      </ng-container>
                      <ng-template #noProfile>
                        <p class="muted profile-empty">Perfil no disponible</p>
                      </ng-template>
                    </div>
                  </div>

                </article>
              </div>
            </div>
          </div>

        </div>

        <article class="panel events-layout__right" *ngIf="!isEventRankingPanelCollapsed">
          <ng-container *ngIf="selectedEvent; else routeTimesPlaceholder">
            <div class="panel__header panel__header--ranking">
              <div>
                <h3>Ranking del evento</h3>
                <p class="muted">Tracks ordenados por tiempo real (el m√°s r√°pido primero).</p>
              </div>
              <label class="ranking-category-filter" aria-label="Filtrar ranking por categor√≠a">
                <span>Categor√≠a</span>
                <select [value]="selectedRankingCategory" (change)="onRankingCategoryChange($any($event.target).value)">
                  <option value="all">Todas</option>
                  <option *ngFor="let category of rankingCategories" [value]="category">{{ category }}</option>
                </select>
              </label>
              <button class="ranking-animate" type="button" (click)="animateSelectedTracks()"
                [disabled]="!selectedComparisonIds.size" aria-label="Animar tracks seleccionados"
                matTooltip="Animar en el mapa los tracks seleccionados en la tabla">
                <span class="ranking-animate__icon" aria-hidden="true">üö¥‚Äç‚ôÄÔ∏è</span>
              </button>
            </div>
            <ng-container *ngIf="routeTrackTimes.length; else emptyRouteTimes">
              <div class="ranking ranking--grid">
                <div class="ranking__header ranking__header--event">
                  <span>#</span>
                  <span>Usuario</span>
                  <span>Tiempo</span>
                  <span class="ranking__select-col">Seleccionar</span>
                  <span class="ranking__download-col">Descargar</span>
                </div>
                <div class="ranking__row ranking__row--event" *ngFor="let track of filteredRouteTrackTimes; index as i">
                  <span class="position">#{{ i + 1 }}</span>
                  <div class="ranking__rider">
                    <p class="strong">{{ track.nickname }}</p>
                    <p class="muted">{{ track.category }}</p>
                  </div>
                  <div class="ranking__meta">
                    <span class="time">{{ formatTime(track.tiempoReal) }}</span>
                  </div>
                  <label class="ranking__checkbox" aria-label="Seleccionar track para animar">
                    <input type="checkbox" [checked]="selectedComparisonIds.has(track.id)"
                      [disabled]="isComparisonSelectionDisabled(track.id)" (change)="toggleComparisonSelection(track.id)" />
                    <span class="ranking__checkbox-box"></span>
                  </label>
                  <button type="button" class="ranking__download" (click)="downloadComparisonTrack(track.id)"
                    aria-label="Descargar track del ranking">
                    <mat-icon aria-hidden="true">file_download</mat-icon>
                  </button>
                </div>
              </div>
              <p *ngIf="!filteredRouteTrackTimes.length" class="muted">No hay tracks en la categor√≠a seleccionada.</p>
            </ng-container>
            <ng-template #emptyRouteTimes>
              <p class="muted">No hay tiempos registrados para este recorrido a√∫n.</p>
            </ng-template>
          </ng-container>
          <ng-template #routeTimesPlaceholder>
            <div class="panel__header">
              <h3>Ranking del evento</h3>
              <p class="muted">Selecciona un evento para cargar los tiempos.</p>
            </div>
          </ng-template>
        </article>
      </section>
    </ng-container>

    <ng-template #emptyEvents>
      <p class="muted">No hay eventos disponibles todav√≠a.</p>
    </ng-template>

    <section *ngIf="events.length" class="event-detail">
      <article class="panel" *ngIf="personalHistory.length">
        <div class="panel__header">
          <h3>Historial de {{ personalNickname }}</h3>
          <p class="muted">Guardamos todos tus intentos, el ranking usa tu mejor tiempo.</p>
        </div>
        <ul class="history">
          <li *ngFor="let track of personalHistory">
            <div>
              <p class="strong">{{ findModalityName(track.modalityId) }}</p>
              <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
            </div>
            <div class="history__meta">
              <span class="pill">{{ formatTime(track.timeSeconds) }}</span>
              <span class="muted">{{ track.uploadedAt | date:'medium' }}</span>
              <button *ngIf="canDeleteTrack(track)" type="button" class="icon-button"
                (click)="deleteTrack(track.id, selectedEventId || undefined)">
                üóëÔ∏è
              </button>
            </div>
          </li>
        </ul>
      </article>
    </section>
  </section>
</div>
