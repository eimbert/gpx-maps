<div class="container">
  <section *ngIf="mode === 'routes'" class="load-wrapper">
    <header class="hero">
      <div>
        <h1>Anima tus Rutas</h1>
        <p>Arrastra y suelta hasta {{ maxTracks }} recorridos o pulsa para seleccionarlos.</p>
        <p *ngIf="!isAuthenticated" class="guest-note">Sin sesi√≥n iniciada solo puedes cargar un archivo GPX a la vez.</p>
      </div>
      
      <button type="button" class="home-button hero__home" style="cursor: pointer;" (click)="goHome()">
        <span class="home-button__icon">üè†</span>
        <span class="home-button__label">Volver al inicio</span>
      </button>
    </header>

    <div
      class="dropzone"
      [class.dropzone--active]="isDragOver"
      (click)="triggerFileDialog()"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave()"
      (drop)="onDrop($event)"
    >
      <input
        #fileInput
        type="file"
        accept=".gpx"
        [attr.multiple]="isAuthenticated ? '' : null"
        (change)="onFileInputChange($event)"
        hidden
      />

      <div class="dropzone__content">
        <div class="icon">üìÇ</div>
        <p class="title">Suelta aqu√≠ tus archivos GPX</p>
        <p class="subtitle">Tambi√©n puedes pulsar para abrir el selector</p>
        <button type="button" class="secondary" style="cursor: pointer;">A√±adir archivos</button>
      </div>
    </div>

    <section class="tracks" *ngIf="tracks.length">
      <h2>Tracks cargados</h2>
      <ul class="file-list">
        <li class="file-item" *ngFor="let track of tracks; index as i">
          <span class="file-pill">{{ i + 1 }}</span>
          <div class="file-texts">
            <span class="file-name" [title]="track.fileName">{{ track.fileName }}</span>
            <span class="file-alias" [title]="track.name">{{ track.name }}</span>
          </div>
          <button type="button" class="ghost" (click)="borrarFichero(i)">Quitar</button>
        </li>
      </ul>
    </section>

    <div class="action-row">
      <button (click)="iniciarVisualizacion()" [disabled]="!tracksCargados()" class="btn-start">
        <span>Iniciar</span>
        <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="btn-start__icon">
          <path d="M5 3l14 9-14 9V3z" fill="currentColor" />
        </svg>
      </button>
    </div>

    <section *ngIf="isAuthenticated" class="user-tracks">
      <div class="user-tracks__header">
        <div>
          <p class="eyebrow">Tracks subidos por ti</p>
          <!-- <h3>Tracks subidos por ti</h3> -->
        </div>
        <button
          type="button"
          class="cloud-upload"
          (click)="openStandaloneUploadDialog()"
          [disabled]="standaloneUploadInProgress">
          <mat-icon aria-hidden="true">cloud_upload</mat-icon>
          <span>Subir track</span>
        </button>
      </div>

      <p class="muted" *ngIf="userTracksLoading">Cargando tus tracks...</p>
      <p class="muted" *ngIf="!userTracksLoading && !userTracks.length">A√∫n no has subido tracks.</p>

      <div class="table-wrapper" *ngIf="!userTracksLoading && userTracks.length">
        <table class="user-tracks__table">
          <thead>
            <tr>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('year')" aria-label="Ordenar por a√±o">
                  A√±o <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('year') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('autonomousCommunity')" aria-label="Ordenar por comunidad">
                  Comunidad <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('autonomousCommunity') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('province')" aria-label="Ordenar por provincia">
                  Provincia <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('province') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('population')" aria-label="Ordenar por poblaci√≥n">
                  Poblaci√≥n <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('population') }}</span>
                </button>
              </th>
              <th>Evento/T√≠tulo</th>
              <th>Distancia</th>
              <th>Tiempo movimiento</th>
              <th>Tiempo total</th>
              <th class="user-tracks__action-col">Descargar</th>
              <th class="user-tracks__action-col">Animar</th>
              <th class="user-tracks__action-col">Eliminar</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of sortedUserTracks">
              <td class="user-tracks__title-col">
                <div class="user-tracks__label" *ngIf="row.eventName && row.eventName !== '-'"> 
                  <span class="user-tracks__pill user-tracks__pill--event">Evento</span>
                  <span class="user-tracks__title user-tracks__title--event">{{ row.eventName }}</span>
                </div>
                <div class="user-tracks__label" *ngIf="row.title">
                  <span class="user-tracks__pill">T√≠tulo</span>
                  <span class="user-tracks__title user-tracks__title--title">{{ row.title }}</span>
                </div>
                <span *ngIf="!row.title && (!row.eventName || row.eventName === '-')">‚Äî</span>
              </td>
              <td>{{ row.year || '-' }}</td>
              <td>{{ row.autonomousCommunity || '‚Äî' }}</td>
              <td>{{ row.province || '‚Äî' }}</td>
              <td>{{ row.population || '‚Äî' }}</td>
              <td style="text-align: right;">{{ row.distanceKm ? (row.distanceKm | number:'1.0-1') + ' km' : '‚Äî' }}</td>
              <td style="text-align: center;">{{ formatDurationHms(row.timeSeconds) }}</td>
              <td style="text-align: center;">{{ formatDurationHms(row.totalTimeSeconds) }}</td>
              <td class="user-tracks__action-col">
                <button
                  type="button"
                  class="ghost ghost--small user-tracks__icon-button"
                  [disabled]="isDownloadingTrack(row)"
                  (click)="downloadUserTrack(row)"
                  [attr.aria-label]="isDownloadingTrack(row) ? 'Descargando track' : 'Descargar track'">
                  <mat-icon aria-hidden="true">{{ isDownloadingTrack(row) ? 'downloading' : 'file_download' }}</mat-icon>
                </button>
              </td>
              <td class="user-tracks__action-col">
                <button
                  type="button"
                  class="ghost ghost--small user-tracks__icon-button"
                  (click)="animateUserTrack(row)"
                  aria-label="Animar track">
                  <mat-icon aria-hidden="true">play_arrow</mat-icon>
                </button>
              </td>
              <td class="user-tracks__action-col">
                <button
                  type="button"
                  class="ghost ghost--small ghost--danger user-tracks__icon-button"
                  [disabled]="isDeletingTrack(row) || !row.canDelete"
                  (click)="confirmDeleteUserTrack(row)"
                  [attr.aria-label]="isDeletingTrack(row) ? 'Eliminando track' : 'Eliminar track'">
                  <mat-icon aria-hidden="true">{{ isDeletingTrack(row) ? 'hourglass_top' : 'delete' }}</mat-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </section>

  <section *ngIf="mode === 'events'" class="events-wrapper">
    <header class="hero events-hero">
      <div>
        <p style="color: beige; padding-bottom: 10px;">Ranking social</p>
        <h1  style="color: lightyellow;">Elige evento, sube tu track y anima la carrera</h1>
        <p style="color: beige;">Explora recorridos</p>
        <p style="color: beige;">S√∫mate al ranking por categor√≠a</p>
        <p style="color: beige;">Compara tu GPX con otros riders</p>
      </div>
    </header>
    <div *ngIf="!isAuthenticated" class="events-locked">
      <p class="events-locked__title">Eventos y rankings est√°n disponibles solo para usuarios registrados.</p>
      <p class="muted">Inicia sesi√≥n o reg√≠strate desde la pantalla principal para subir y comparar tracks.</p>
      <button type="button" class="secondary" (click)="goHome()">Volver a la pantalla principal</button>
    </div>

    <ng-container *ngIf="isAuthenticated">
      <div class="events-actions">
        <div class="events-menu">
          <button
            type="button"
            mat-raised-button
            color="primary"
            class="menu-toggle"
            [matMenuTriggerFor]="eventsMenu"
            #eventsMenuTrigger="matMenuTrigger"
            (menuOpened)="eventMenuOpen = true"
            (menuClosed)="eventMenuOpen = false">
            <span class="menu-toggle__label">
              <mat-icon aria-hidden="true">event</mat-icon>
              <span>Men√∫ de eventos</span>
            </span>
            <mat-icon class="chevron" [class.chevron--open]="eventMenuOpen" aria-hidden="true">expand_more</mat-icon>
          </button>
          <mat-menu #eventsMenu="matMenu" class="events-mat-menu">
            <button mat-menu-item type="button" (click)="openUploadTrackDialog()">
              <mat-icon aria-hidden="true">file_upload</mat-icon>
              <span>Subir track</span>
            </button>
            <button mat-menu-item type="button" (click)="openCreateEventDialog()">
              <mat-icon aria-hidden="true">add_circle</mat-icon>
              <span>Crear evento</span>
            </button>
            <button mat-menu-item type="button" (click)="openEventSearch()">
              <mat-icon aria-hidden="true">format_list_bulleted</mat-icon>
              <span>Lista eventos</span>
            </button>
            <button mat-menu-item type="button" [disabled]="!canDeleteSelectedEvent()" (click)="deleteSelectedEvent()">
              <mat-icon aria-hidden="true">delete</mat-icon>
              <span>Eliminar evento</span>
            </button>
            <button mat-menu-item type="button" (click)="openMyTracksDialog()">
              <mat-icon aria-hidden="true">folder_shared</mat-icon>
              <span>Mis tracks</span>
            </button>
            <button mat-menu-item type="button" (click)="goHome(); closeEventMenu()">
              <mat-icon aria-hidden="true">home</mat-icon>
              <span>Volver al inicio</span>
            </button>
          </mat-menu>
        </div>
      </div>
      <input #masterGpxInput type="file" accept=".gpx" hidden (change)="onMasterGpxFileChange($event)" />

      <ng-container *ngIf="events.length; else emptyEvents">
        <div class="events-carousel">
          <div class="carousel-window">
            <div class="carousel-track">
              
            <article
              *ngFor="let event of events; index as i"
              class="event-card event-card--carousel"
              [class.event-card--active]="event.id === selectedEventId"
              [class.event-card--current]="i === carouselIndex"
              
              (click)="handleCarouselSelection(event.id)"
            >
                <div class="event-card__content">
                  <div class="event-card__info">
                    <p class="eyebrow">{{ event.year }}</p>
                    <div class="event-card__title-row">
                      <div class="event-logo event-logo--badge">
                        <ng-container *ngIf="event.logoBlob; else logoPlaceholderSmall">
                          <img [src]="getEventLogo(event)" [alt]="event.name + ' logo'" />
                        </ng-container>
                        <ng-template #logoPlaceholderSmall>
                          <span class="muted">Logo</span>
                        </ng-template>
                      </div>
                      <div>
                        <p class="event-card__title">{{ event.name }}</p>
                        <p class="muted event-card__subtitle">{{ getEventLocation(event) || 'Ubicaci√≥n pendiente' }}</p>
                      </div>
                    </div>
                    <p class="event-meta"><strong>Poblaci√≥n:</strong> {{ event.population || 'Sin datos' }}</p>
                    <p class="event-meta"><strong>Comunidad:</strong> {{ event.autonomousCommunity || 'Sin datos' }}</p>
                    <div class="event-profile">
                      <ng-container *ngIf="eventVisuals[event.id]?.profile?.points; else noProfile">
                        <div class="profile-chart-wrapper">
                          <svg [attr.viewBox]="'0 0 ' + profileWidth + ' ' + profileHeight" preserveAspectRatio="none" class="profile-chart">
                            <g class="grid-lines">
                              <line
                                *ngFor="let y of eventVisuals[event.id].profile?.gridLinesY"
                                x1="0"
                                [attr.y1]="y"
                                [attr.y2]="y"
                                [attr.x2]="profileWidth" />
                            </g>
                            <polyline [attr.points]="eventVisuals[event.id].profile?.points"></polyline>
                          </svg>
                          <div class="profile-legend" *ngIf="eventVisuals[event.id].profile as profile">
                            <div class="legend-row">
                              <span>Altura inicial:</span>
                              <strong>{{ profile.stats.initialElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row">
                              <span>Altura m√°xima:</span>
                              <strong>{{ profile.stats.maxElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row">
                              <span>Distancia:</span>
                              <strong>{{ profile.stats.distanceKm | number: '1.0-1' }} km</strong>
                            </div>
                            <div class="legend-row">
                              <span>Tracks subidos:</span>
                              <strong>{{ event.tracks.length }}</strong>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #noProfile>
                        <p class="muted profile-empty">Perfil no disponible</p>
                      </ng-template>
                    </div>
                  </div>
                  <div class="event-card__map" [ngStyle]="getMapBackgroundStyle(event.id)">
                    <ng-container *ngIf="eventVisuals[event.id]?.trackPath; else missingTrack">
                      <svg viewBox="0 0 320 240" preserveAspectRatio="none" class="track-drawing">
                        <polyline [attr.points]="eventVisuals[event.id].trackPath"></polyline>
                      </svg>
                    </ng-container>
                    <ng-template #missingTrack>
                      <div class="no-track">
                        <p class="muted">No se dispone de track</p>
                        <button
                          *ngIf="canUploadMasterGpx(event)"
                          type="button"
                          class="secondary"
                          (click)="promptMasterGpxUpload(event.id); $event.stopPropagation();">
                          Subir track
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </div>

              </article>
            </div>
          </div>
        </div>


      </ng-container>

      <ng-template #emptyEvents>
        <p class="muted">No hay eventos disponibles todav√≠a.</p>
      </ng-template>

      <section *ngIf="events.length" class="event-detail">
        <div class="event-panels">
        <!-- <article class="panel">
          <ng-container *ngIf="selectedEvent; else rankingPlaceholder">
            <div class="panel__header">
              <h3>Ranking mejor tiempo</h3>
              <p class="muted">Tu mejor marca se conserva, el resto queda en historial personal.</p>
            </div>
            <ol class="ranking">
              <li *ngFor="let track of ranking; index as i" [class.ranking__item--mine]="track.id === latestUploadedTrackId || track.nickname === personalNickname">
                <span class="position">#{{ i + 1 }}</span>
                <div>
                  <p class="strong">{{ track.nickname }} ¬∑ {{ findModalityName(track.modalityId) }}</p>
                  <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
                </div>
                <div class="ranking__actions">
                  <span class="time">{{ formatTime(track.timeSeconds) }}</span>
                  <button
                    *ngIf="canDeleteTrack(track)"
                    type="button"
                    class="icon-button"
                    (click)="deleteTrack(track.id)">
                    üóëÔ∏è
                  </button>
                </div>
              </li>
            </ol>
          </ng-container>
          <ng-template #rankingPlaceholder>
            <div class="panel__header">
              <h3>Ranking mejor tiempo</h3>
              <p class="muted">Selecciona un evento para ver el ranking.</p>
            </div>
          </ng-template>
        </article> -->

        <article class="panel">
          <ng-container *ngIf="selectedEvent; else routeTimesPlaceholder">
            <div class="panel__header">
              <h3>Tiempos de la ruta</h3>
              <p class="muted">Datos obtenidos al seleccionar el recorrido en el carrusel.</p>
            </div>
            <ng-container *ngIf="routeTrackTimes.length; else emptyRouteTimes">
              <ol class="ranking">
                <li *ngFor="let track of routeTrackTimes; index as i">
                  <span class="position">#{{ i + 1 }}</span>
                  <div>
                    <p class="strong">{{ track.nickname }}</p>
                    <p class="muted">{{ track.category }}</p>
                  </div>
                  <div class="ranking__actions">
                    <span class="pill">{{ track.distanceKm | number:'1.0-1' }} km</span>
                    <span class="time">{{ formatTime(track.tiempoReal) }}</span>
                  </div>
                </li>
              </ol>
            </ng-container>
            <ng-template #emptyRouteTimes>
              <p class="muted">No hay tiempos registrados para este recorrido a√∫n.</p>
            </ng-template>
          </ng-container>
          <ng-template #routeTimesPlaceholder>
            <div class="panel__header">
              <h3>Tiempos de la ruta</h3>
              <p class="muted">Selecciona un evento para cargar los tiempos.</p>
            </div>
          </ng-template>
        </article>
      </div>

      <article class="panel">
        <ng-container *ngIf="selectedEvent; else selectionPlaceholder">
          <div class="panel__header">
            <h3>Elige hasta 4 rivales</h3>
            <p class="muted">Activa los que quieras comparar y pulsa "Animar selecci√≥n".</p>
          </div>
          <div class="track-grid">
            <label class="track-card" *ngFor="let track of availableTracks">
              <input type="checkbox" [checked]="selectedComparisonIds.has(track.id)" (change)="toggleComparisonSelection(track.id)" />
              <div>
                <p class="strong">{{ track.nickname }} ¬∑ {{ findModalityName(track.modalityId) }}</p>
                <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }} ¬∑ {{ formatTime(track.timeSeconds) }}</p>
              </div>
              <span class="pill">{{ track.distanceKm | number:'1.0-1' }} km</span>
              <button
                *ngIf="canDeleteTrack(track)"
                type="button"
                class="icon-button"
                (click)="deleteTrack(track.id); $event.stopPropagation(); $event.preventDefault();">
                üóëÔ∏è
              </button>
            </label>
          </div>
          <div class="actions">
            <button class="btn-start" type="button" (click)="animateSelectedTracks()">Animar selecci√≥n</button>
          </div>
        </ng-container>
        <ng-template #selectionPlaceholder>
          <div class="panel__header">
            <h3>Elige hasta 4 rivales</h3>
            <p class="muted">Selecciona un evento para ver los aportes disponibles.</p>
          </div>
        </ng-template>
      </article>

        <article class="panel" *ngIf="personalHistory.length">
          <div class="panel__header">
            <h3>Historial de {{ personalNickname }}</h3>
            <p class="muted">Guardamos todos tus intentos, el ranking usa tu mejor tiempo.</p>
          </div>
          <ul class="history">
            <li *ngFor="let track of personalHistory">
              <div>
                <p class="strong">{{ findModalityName(track.modalityId) }}</p>
                <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
              </div>
              <div class="history__meta">
                <span class="pill">{{ formatTime(track.timeSeconds) }}</span>
                <span class="muted">{{ track.uploadedAt | date:'medium' }}</span>
                <button
                  *ngIf="canDeleteTrack(track)"
                  type="button"
                  class="icon-button"
                  (click)="deleteTrack(track.id, selectedEventId || undefined)">
                  üóëÔ∏è
                </button>
              </div>
            </li>
          </ul>
        </article>
      </section>
    </ng-container>
  </section>
</div>
