<div class="container">
  <section *ngIf="mode === 'routes'" class="load-wrapper">
    <header class="hero">
      <div>
        <h1>Anima tus Rutas</h1>
        <p>Arrastra y suelta hasta {{ maxTracks }} recorridos o pulsa para seleccionarlos.</p>
        <p *ngIf="!isAuthenticated" class="guest-note">Sin sesi√≥n iniciada solo puedes cargar un archivo GPX a la vez.
        </p>
      </div>

      
    </header>
    <div style=" margin-top:28px;">
      <button type="button" class="event-action-button event-action-button--home hero__home" (click)="goHome()"
          matTooltip="Volver al inicio" aria-label="Volver al inicio">
          <mat-icon aria-hidden="true">home</mat-icon>
      </button>
    </div>

    <div class="dropzone" [class.dropzone--active]="isDragOver" (click)="triggerFileDialog()"
      (dragover)="onDragOver($event)" (dragleave)="onDragLeave()" (drop)="onDrop($event)">
      <input #fileInput type="file" accept=".gpx" [attr.multiple]="isAuthenticated ? '' : null"
        (change)="onFileInputChange($event)" hidden />

      <div class="dropzone__content">
        <div class="icon">üìÇ</div>
        <p class="title">Suelta aqu√≠ tus archivos GPX</p>
        <p class="subtitle">Tambi√©n puedes pulsar para abrir el selector</p>
        <button type="button" class="secondary" style="cursor: pointer;">A√±adir archivos</button>
      </div>
    </div>

    <section class="tracks" *ngIf="tracks.length">
      <h2>Rutas cargadas</h2>
      <ul class="file-list">
        <li class="file-item" *ngFor="let track of tracks; index as i">
          <span class="file-pill">{{ i + 1 }}</span>
          <div class="file-texts">
            <span class="file-name" [title]="track.fileName">{{ track.fileName }}</span>
            <span class="file-alias" [title]="track.name">{{ track.name }}</span>
          </div>
          <button type="button" style="cursor: pointer;" class="ghost" (click)="borrarFichero(i)">Quitar</button>
        </li>
      </ul>
    </section>

    <div class="action-row">
      <button (click)="iniciarVisualizacion()" [disabled]="!tracksCargados()" class="btn-start"
        matTooltip="Iniciar la animaci√≥n de los tracks cargados">
        <span>Iniciar</span>
        <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="btn-start__icon">
          <path d="M5 3l14 9-14 9V3z" fill="currentColor" />
        </svg>
      </button>
    </div>

    <section *ngIf="isAuthenticated" class="user-tracks">
      <div class="user-tracks__header">
        <div>
          <p class="eyebrow">Rutas disponibles</p>
        </div>
        <button type="button" class="cloud-upload" (click)="openStandaloneUploadDialog()"
          [disabled]="standaloneUploadInProgress">
          <mat-icon aria-hidden="true">cloud_upload</mat-icon>
          <span>Subir ruta</span>
        </button>
      </div>

      <div class="user-tracks__tabs">
        <button type="button" class="user-tracks__tab" [class.user-tracks__tab--active]="activeUserTracksTab === 'personal'"
          (click)="setUserTracksTab('personal')" aria-label="Ver tus rutas personales">
          <span>Tus rutas</span>
          <span class="user-tracks__tab-count">{{ getUserTrackRows('personal').length }}</span>
        </button>
        <button type="button" class="user-tracks__tab" [class.user-tracks__tab--active]="activeUserTracksTab === 'events'"
          (click)="setUserTracksTab('events')" aria-label="Ver tus rutas de eventos">
          <span>Rutas de Eventos</span>
          <span class="user-tracks__tab-count">{{ getUserTrackRows('events').length }}</span>
        </button>
        <button type="button" class="user-tracks__tab" [class.user-tracks__tab--active]="activeUserTracksTab === 'shared'"
          (click)="setUserTracksTab('shared')" aria-label="Ver rutas de otros usuarios">
          <span>Rutas otros usuarios</span>
          <span class="user-tracks__tab-count">{{ getUserTrackRows('shared').length }}</span>
        </button>
      </div>

      <p class="muted" *ngIf="activeTracksLoading">{{ activeTracksLoadingLabel }}</p>
      <p class="muted" *ngIf="!activeTracksLoading && !getUserTrackRows(activeUserTracksTab).length">{{ activeTracksEmptyMessage }}</p>

      <div class="user-tracks__panel" *ngIf="!activeTracksLoading && getUserTrackRows(activeUserTracksTab).length">
        <div class="user-tracks__table-toolbar">
          <div class="user-tracks__filter">
            <mat-icon aria-hidden="true">search</mat-icon>
            <input type="text" [value]="userTracksFilter" (input)="onUserTracksFilter($any($event.target)?.value || '')" placeholder="Buscar por t√≠tulo, evento o ubicaci√≥n" aria-label="Filtrar rutas guardadas">
          </div>
          <div class="user-tracks__counts">
            <span class="user-tracks__count">{{ filteredUserTracks.length }} rutas</span>
            <span class="user-tracks__range" *ngIf="filteredUserTracks.length && filteredUserTracks.length !== paginatedUserTracks.length">
              Mostrando {{ userTracksRangeStart }}-{{ userTracksRangeEnd }}
            </span>
          </div>
        </div>

        <p-table [value]="paginatedUserTracks" styleClass="user-tracks__table p-datatable-sm p-datatable-hoverable-rows" aria-label="Rutas guardadas" >
          <ng-template pTemplate="header">
            <tr>
              <th>Ruta</th>
              <th style="text-align: left;">Nickname</th>
              <th style="text-align: left;">
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('year')" aria-label="Ordenar por a√±o">
                  A√±o <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('year') }}</span>
                </button>
              </th>
              <th style="text-align: left;">
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('autonomousCommunity')" aria-label="Ordenar por comunidad">
                  Comunidad <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('autonomousCommunity') }}</span>
                </button>
              </th>
              <th style="text-align: left;">
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('province')" aria-label="Ordenar por provincia">
                  Provincia <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('province') }}</span>
                </button>
              </th>
              <th style="text-align: left;">
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('population')" aria-label="Ordenar por poblaci√≥n">
                  Poblaci√≥n <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('population') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('distanceKm')" aria-label="Ordenar por distancia">
                  Distancia <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('distanceKm') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('timeSeconds')" aria-label="Ordenar por tiempo en movimiento">
                  Tiempo <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('timeSeconds') }}</span>
                </button>
              </th>
              <th>
                <button type="button" class="user-tracks__sort" (click)="sortUserTracksBy('totalTimeSeconds')" aria-label="Ordenar por tiempo total">
                  Tiempo total <span class="user-tracks__sort-indicator">{{ resolveUserTracksSortIndicator('totalTimeSeconds') }}</span>
                </button>
              </th>
              <th class="user-tracks__action-col">Descargar</th>
              <th class="user-tracks__action-col">Animar</th>
              <th class="user-tracks__action-col">Eliminar</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-row>
            <tr class="p-selectable-row">
              <td class="user-tracks__title-col">
                <div class="user-tracks__label" *ngIf="row.eventName && row.eventName !== '-'">
                  <!-- <span class="user-tracks__pill user-tracks__pill--event">Evento</span> -->
                  <span class="user-tracks__title user-tracks__title--event">{{ row.eventName }} (E)</span>
                </div>
                <div class="user-tracks__label" *ngIf="row.title">
                  <!-- <span class="user-tracks__pill">T√≠tulo</span> -->
                  <span class="user-tracks__title user-tracks__title--title">{{ row.title }}</span>
                </div>
                <span *ngIf="!row.title && (!row.eventName || row.eventName === '-')">‚Äî</span>
              </td>
              <td>{{ row.nickname || '‚Äî' }}</td>
              <td>{{ row.year || '-' }}</td>
              <td>{{ row.autonomousCommunity || '‚Äî' }}</td>
              <td>{{ row.province || '‚Äî' }}</td>
              <td>{{ row.population || '‚Äî' }}</td>
              <td class="user-tracks__metric user-tracks__metric--right">{{ row.distanceLabel }}</td>
              <td class="user-tracks__metric user-tracks__metric--center">{{ row.movingTimeLabel }}</td>
              <td class="user-tracks__metric user-tracks__metric--center">{{ row.totalTimeLabel }}</td>
              <td class="user-tracks__action-col">
                <button type="button" class="ghost ghost--small user-tracks__icon-button" [disabled]="isDownloadingTrack(row)" (click)="downloadUserTrack(row)" [attr.aria-label]="isDownloadingTrack(row) ? 'Descargando track' : 'Descargar track'">
                  <mat-icon aria-hidden="true" style="color: blue;">{{ isDownloadingTrack(row) ? 'downloading' : 'file_download' }}</mat-icon>
                </button>
              </td>
              <td class="user-tracks__action-col">
                <button type="button" class="ghost ghost--small user-tracks__icon-button" (click)="animateUserTrack(row)" aria-label="Animar track">
                  <mat-icon aria-hidden="true" style="color: orange;">play_arrow</mat-icon>
                </button>
              </td>
              <td class="user-tracks__action-col">
                <button type="button" class="ghost ghost--small ghost--danger user-tracks__icon-button" [disabled]="isDeletingTrack(row)" (click)="confirmDeleteUserTrack(row)" [attr.aria-label]="isDeletingTrack(row) ? 'Eliminando track' : 'Eliminar track'">
                  <mat-icon aria-hidden="true" >{{ isDeletingTrack(row) ? 'hourglass_top' : 'delete' }}</mat-icon>
                </button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <div class="user-tracks__empty">No hay rutas que coincidan con la b√∫squeda.</div>
          </ng-template>

          <ng-template pTemplate="footer">
            <div class="user-tracks__pagination">
              <div class="user-tracks__pagination-rows">
                <label for="userTracksRows">Filas:</label>
                <select id="userTracksRows" [value]="userTracksRows" (change)="onUserTracksRowsChange($any($event.target).value)">
                  <option *ngFor="let option of userTracksRowsOptions" [value]="option">{{ option }}</option>
                </select>
              </div>
              <div class="user-tracks__pagination-controls">
                <button type="button" style="cursor: pointer;" class="ghost ghost--small" (click)="changeUserTracksPage(-1)" [disabled]="userTracksPage === 0 || !userTracksPageCount">Anterior</button>
                <span class="user-tracks__page-indicator">
                  P√°gina {{ userTracksPageCount ? userTracksPage + 1 : 0 }} / {{ userTracksPageCount || 0 }}
                </span>
                <button type="button" style="cursor: pointer;" class="ghost ghost--small" (click)="changeUserTracksPage(1)" [disabled]="!userTracksPageCount || userTracksPage + 1 >= userTracksPageCount">Siguiente</button>
              </div>
            </div>
          </ng-template>
        </p-table>
      </div>
    </section>
  </section>

  <section *ngIf="mode === 'events'" class="events-wrapper">
    <header class="hero events-hero">
      <div>
        <p style="color: beige; padding-bottom: 10px;">Ranking social</p>
        <h1 style="color: lightyellow;">Elige evento, sube tu track y anima la carrera</h1>
        <p style="color: beige;">Explora recorridos</p>
        <p style="color: beige;">S√∫mate al ranking por categor√≠a</p>
        <p style="color: beige;">Compara tu GPX con otros riders</p>
      </div>
    </header>
    <div *ngIf="!isAuthenticated" class="events-locked">
      <p class="events-locked__title">Explora y anima eventos sin registrarte.</p>
      <p class="muted">Inicia sesi√≥n o reg√≠strate desde la pantalla principal si quieres subir o gestionar rutas.</p>
      <button type="button" class="secondary" (click)="goHome()">Volver a la pantalla principal</button>
    </div>

    <div class="events-actions"  style="margin-top:28px;">
      <div class="events-actions__buttons">
        <button type="button" class="event-action-button event-action-button--home" (click)="goHome()"
          matTooltip="Volver al inicio" aria-label="Volver al inicio">
          <mat-icon aria-hidden="true">home</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openUploadTrackDialog()"
          matTooltip="Subir ruta" aria-label="Subir ruta">
          <mat-icon aria-hidden="true">file_upload</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openCreateEventDialog()"
          matTooltip="Crear evento" aria-label="Crear evento">
          <mat-icon aria-hidden="true">add_circle</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openEventSearch()"
          matTooltip="Lista de eventos" aria-label="Lista de eventos">
          <mat-icon aria-hidden="true">format_list_bulleted</mat-icon>
        </button>
        <button type="button" class="event-action-button" [disabled]="!canDeleteSelectedEvent()"
          (click)="deleteSelectedEvent()" matTooltip="Eliminar evento"
          aria-label="Eliminar evento">
          <mat-icon aria-hidden="true">delete</mat-icon>
        </button>
        <button type="button" class="event-action-button" (click)="openMyTracksDialog()"
          matTooltip="Mis tracks" aria-label="Mis tracks">
          <mat-icon aria-hidden="true">folder_shared</mat-icon>
        </button>
      </div>
    </div>
    <input #masterGpxInput type="file" accept=".gpx" hidden (change)="onMasterGpxFileChange($event)" />

    <ng-container *ngIf="events.length; else emptyEvents">
      <div class="events-carousel">
        <div class="carousel-window">
          <div class="carousel-track">

            <article *ngFor="let event of events; index as i" class="event-card event-card--carousel"
              [class.event-card--active]="event.id === selectedEventId"
              [class.event-card--current]="i === carouselIndex" (click)="handleCarouselSelection(event.id)">
              <div class="event-card__content">
                <div class="event-card__info">
                  <p class="eyebrow">{{ event.year }}</p>
                  <div class="event-card__title-row">
                    <div class="event-logo event-logo--badge">
                      <ng-container *ngIf="event.logoBlob; else logoPlaceholderSmall">
                        <img [src]="getEventLogo(event)" [alt]="event.name + ' logo'" />
                      </ng-container>
                      <ng-template #logoPlaceholderSmall>
                        <span class="muted">Logo</span>
                      </ng-template>
                    </div>
                    <div>
                      <p class="event-card__title">{{ event.name }}</p>
                      <p class="muted event-card__subtitle">{{ getEventLocation(event) || 'Ubicaci√≥n pendiente' }}</p>
                    </div>
                  </div>
                  <p class="event-meta"><strong>Poblaci√≥n:</strong> {{ event.population || 'Sin datos' }}</p>
                  <p class="event-meta"><strong>Provincia:</strong> {{ event.population || 'Sin datos' }}</p>
                  <p class="event-meta"><strong>Comunidad:</strong> {{ event.autonomousCommunity || 'Sin datos' }}</p>
                  <div class="event-profile-row">
                    <div class="event-profile">
                      <ng-container *ngIf="eventVisuals[event.id]?.profile?.points; else noProfile">
                        <div class="profile-chart-wrapper">
                          <svg [attr.viewBox]="'0 0 ' + profileWidth + ' ' + profileHeight" preserveAspectRatio="none"
                            class="profile-chart">
                            <g class="grid-lines">
                              <ng-container *ngFor="let line of eventVisuals[event.id].profile?.gridLines">
                                <line x1="0" [attr.y1]="line.y" [attr.y2]="line.y" [attr.x2]="profileWidth" />
                                <text class="grid-label" x="4" [attr.y]="line.labelY">{{ line.label }}</text>
                              </ng-container>
                            </g>
                            <polyline [attr.points]="eventVisuals[event.id].profile?.points"></polyline>
                          </svg>
                          <div class="profile-legend" *ngIf="eventVisuals[event.id].profile as profile">
                            <div class="legend-row legend-row--altitude">
                              <span>Altura inicial:</span>
                              <strong>{{ profile.stats.initialElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row legend-row--altitude">
                              <span>Altura m√°xima:</span>
                              <strong>{{ profile.stats.maxElevation | number: '1.0-0' }} m</strong>
                            </div>
                            <div class="legend-row">
                              <span>Distancia:</span>
                              <strong>{{ profile.stats.distanceKm | number: '1.0-1' }} km</strong>
                            </div>
                            <div class="legend-row legend-row--tracks">
                              <span>Tracks subidos:</span>
                              <div class="legend-row__actions">
                                <strong>{{ event.tracks.length }}</strong>

                              </div>
                            </div>
                            <div class="legend-row" style="border-style: none;">

                            </div>
                            <button type="button" class="cloud-download"
                              [disabled]="!hasMasterTrack(event) || isDownloadingMaster(event.id)"
                              (click)="downloadEventMaster(event, $event)">
                              <mat-icon aria-hidden="true">cloud_download</mat-icon>
                              <span *ngIf="!isDownloadingMaster(event.id)">Bajar track</span>
                              <span *ngIf="isDownloadingMaster(event.id)">Bajando...</span>
                            </button>
                          </div>

                        </div>
                      </ng-container>
                      <ng-template #noProfile>
                        <p class="muted profile-empty">Perfil no disponible</p>
                      </ng-template>
                    </div>
                  </div>
                </div>
                <div class="event-card__map">
                  <ng-container *ngIf="eventVisuals[event.id]?.trackPath; else missingTrack">
                    <svg viewBox="0 0 320 240" preserveAspectRatio="none" class="track-drawing">
                      <polyline [attr.points]="eventVisuals[event.id].trackPath"></polyline>
                    </svg>
                  </ng-container>
                  <ng-template #missingTrack>
                    <div class="no-track">
                      <p class="muted">No se dispone de track</p>
                      <button *ngIf="canUploadMasterGpx(event)" type="button" class="secondary"
                        (click)="promptMasterGpxUpload(event.id); $event.stopPropagation();">
                        Subir track
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>

            </article>
          </div>
        </div>
      </div>

      <div class="carousel-controls">
        <button type="button" class="carousel-button" (click)="prevEvent(true)" aria-label="Evento anterior"
          matTooltip="Ir al evento anterior del carrusel">
          <mat-icon aria-hidden="true">skip_previous</mat-icon>
        </button>
        <button type="button" class="carousel-button carousel-button--primary" (click)="toggleCarouselPlayback()"
          [attr.aria-label]="isCarouselPaused ? 'Reanudar carrusel' : 'Pausar carrusel'"
          [matTooltip]="isCarouselPaused ? 'Reanudar reproducci√≥n autom√°tica' : 'Pausar reproducci√≥n autom√°tica'">
          <mat-icon aria-hidden="true">{{ isCarouselPaused ? 'play_arrow' : 'pause' }}</mat-icon>
        </button>
        <button type="button" class="carousel-button" (click)="nextEvent(true)" aria-label="Siguiente evento"
          matTooltip="Avanzar al siguiente evento del carrusel">
          <mat-icon aria-hidden="true">skip_next</mat-icon>
        </button>
      </div>


    </ng-container>

    <ng-template #emptyEvents>
      <p class="muted">No hay eventos disponibles todav√≠a.</p>
    </ng-template>

    <section *ngIf="events.length" class="event-detail">
        <div class="event-panels">
         

          <article class="panel">
            <ng-container *ngIf="selectedEvent; else routeTimesPlaceholder">
              <div class="panel__header panel__header--ranking">
                <div>
                  <h3>Tiempos de la ruta</h3>
                  <p class="muted">Datos obtenidos al seleccionar el recorrido en el carrusel.</p>
                </div>
                <div style="text-align: right; margin-right: 27px;">
                  <button class="ranking-animate" type="button" (click)="animateSelectedTracks()"
                    [disabled]="!selectedComparisonIds.size" aria-label="Animar tracks seleccionados"
                    matTooltip="Animar en el mapa los tracks seleccionados en la tabla">
                    <span class="ranking-animate__icon" aria-hidden="true">üö¥‚Äç‚ôÄÔ∏è</span>
                  </button>
                </div>
              </div>
              <ng-container *ngIf="routeTrackTimes.length; else emptyRouteTimes">
                <div class="ranking ranking--grid">
                  <div class="ranking__header">
                    <span>#</span>
                    <span>Rider</span>
                    <span>Datos</span>
                    <span class="ranking__select-col">Seleccionar</span>
                  </div>
                  <div class="ranking__row" *ngFor="let track of routeTrackTimes; index as i">
                    <span class="position">#{{ i + 1 }}</span>
                    <div class="ranking__rider">
                      <p class="strong">{{ track.nickname }}</p>
                      <p class="muted">{{ track.category }}</p>
                    </div>
                    <div class="ranking__meta">
                      <span class="pill">{{ track.distanceKm | number:'1.0-1' }} km</span>
                      <span class="time">{{ formatTime(track.tiempoReal) }}</span>
                    </div>
                    <label class="ranking__checkbox" aria-label="Seleccionar track para animar">
                      <input type="checkbox" [checked]="selectedComparisonIds.has(track.id)"
                        (change)="toggleComparisonSelection(track.id)" />
                      <span class="ranking__checkbox-box"></span>
                    </label>
                  </div>
                </div>
              </ng-container>
              <ng-template #emptyRouteTimes>
                <p class="muted">No hay tiempos registrados para este recorrido a√∫n.</p>
              </ng-template>
            </ng-container>
            <ng-template #routeTimesPlaceholder>
              <div class="panel__header">
                <h3>Tiempos de la ruta</h3>
                <p class="muted">Selecciona un evento para cargar los tiempos.</p>
              </div>
            </ng-template>
          </article>
        </div>

        <article class="panel" *ngIf="personalHistory.length">
          <div class="panel__header">
            <h3>Historial de {{ personalNickname }}</h3>
            <p class="muted">Guardamos todos tus intentos, el ranking usa tu mejor tiempo.</p>
          </div>
          <ul class="history">
            <li *ngFor="let track of personalHistory">
              <div>
                <p class="strong">{{ findModalityName(track.modalityId) }}</p>
                <p class="muted">{{ track.category }} ¬∑ {{ track.bikeType }}</p>
              </div>
              <div class="history__meta">
                <span class="pill">{{ formatTime(track.timeSeconds) }}</span>
                <span class="muted">{{ track.uploadedAt | date:'medium' }}</span>
                <button *ngIf="canDeleteTrack(track)" type="button" class="icon-button"
                  (click)="deleteTrack(track.id, selectedEventId || undefined)">
                  üóëÔ∏è
                </button>
              </div>
            </li>
          </ul>
        </article>
      </section>
  </section>
</div>